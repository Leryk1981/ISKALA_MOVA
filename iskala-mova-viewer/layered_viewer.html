<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISKALA/MOVA Layered String Viewer</title>
    <!-- Prism.js –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #ffffff;
            color: #333333;
            height: 100vh;
            display: flex;
        }

        .layer-picker {
            width: 80px;
            background: #f5f5f5;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            border-right: 1px solid #e0e0e0;
        }

        .layer-square {
            width: 50px;
            height: 50px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .layer-square:hover {
            transform: scale(1.1);
        }

        .layer-square.active {
            transform: scale(1.2);
            box-shadow: 0 0 15px currentColor;
        }

        .mova { background: #26a65b; }
        .jalm { background: #f1b80a; }
        .code { background: #1e50a2; }
        .log { background: #3b246c; }
        .error { background: #e53935; }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .layer-item {
            margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }

        .layer-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .layer-header:hover {
            background: #f0f0f0;
        }

        .layer-icon {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .layer-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.3s;
        }

        .expand-btn.expanded {
            transform: rotate(90deg);
        }

        .layer-content {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            display: none;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .edit-controls {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
        }

        .edit-btn, .save-btn, .cancel-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .edit-btn {
            background: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background: #0056b3;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .save-btn:hover {
            background: #1e7e34;
        }

        .cancel-btn {
            background: #dc3545;
            color: white;
        }

        .cancel-btn:hover {
            background: #c82333;
        }

        .edit-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            background: #fff;
        }

        .edit-textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0,123,255,0.3);
        }

        /* –ü–∞–Ω–µ–ª—å –º–µ—Ç—Ä–∏–∫ */
        .metrics-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .metrics-panel.show {
            display: block;
        }

        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .metrics-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .metrics-toggle {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .layer-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .layer-metric {
            background: white;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            border-left: 4px solid;
        }

        .layer-metric.mova { border-left-color: #26a65b; }
        .layer-metric.jalm { border-left-color: #f1b80a; }
        .layer-metric.code { border-left-color: #1e50a2; }
        .layer-metric.log { border-left-color: #3b246c; }
        .layer-metric.error { border-left-color: #e53935; }

        .layer-metric-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .layer-metric-label {
            font-size: 11px;
            color: #666;
        }

        .layer-content.expanded {
            display: block;
        }

        .mova-text { color: #26a65b; }
        .jalm-text { color: #f1b80a; }
        .code-text { color: #1e50a2; }
        .log-text { color: #3b246c; }
        .error-text { color: #e53935; }

        .empty-state {
            text-align: center;
            color: #999;
            margin-top: 50px;
            font-size: 18px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .toolbar-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .toolbar-btn:hover {
            background: #0056b3;
        }

        .toolbar-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .layer-filter {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É */
        .layer-content pre {
            margin: 0;
            background: #2d3748;
            border-radius: 4px;
        }

        .layer-content code {
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –º–æ–≤ */
        .jalm-content pre {
            background: #1a202c;
        }

        .code-content pre {
            background: #1e3a8a;
        }

        .log-content pre {
            background: #1e1b4b;
        }

        .error-content pre {
            background: #7f1d1d;
        }
    </style>
</head>
<body>
    <div class="layer-picker">
        <button class="layer-square mova" data-layer="mova" title="MOVA">üíö</button>
        <button class="layer-square jalm" data-layer="jalm" title="JALM">üü®</button>
        <button class="layer-square code" data-layer="code" title="CODE">üü¶</button>
        <button class="layer-square log" data-layer="log" title="LOG">üü™</button>
        <button class="layer-square error" data-layer="error" title="ERROR">üü•</button>
    </div>

    <div class="main-content" id="mainContent">
        <div class="toolbar">
            <button id="loadDemo" class="toolbar-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–µ–º–æ</button>
            <button id="loadFromFile" class="toolbar-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ —Ñ–∞–π–ª—É</button>
            <button id="loadFromAPI" class="toolbar-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ API</button>
            <button id="exportJSON" class="toolbar-btn">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
            <button id="exportTXT" class="toolbar-btn">–ï–∫—Å–ø–æ—Ä—Ç TXT</button>
                                <input type="file" id="fileInput" accept=".json,.txt,.py,.js,.ts,.html,.css,.md,.xml,.yaml,.yml" style="display: none;">
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫ –ø–æ –∫–∞–ø—Å—É–ª—ñ..." class="search-input">
            <select id="layerFilter" class="layer-filter">
                <option value="">–í—Å—ñ —à–∞—Ä–∏</option>
                <option value="mova">MOVA</option>
                <option value="jalm">JALM</option>
                <option value="code">CODE</option>
                <option value="log">LOG</option>
                <option value="error">ERROR</option>
            </select>
        </div>
        <div class="empty-state">–û–±–µ—Ä—ñ—Ç—å —à–∞—Ä–∏ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –¥–∞–Ω—ñ</div>
    </div>

    <script>
        // Demo data
        const capsule = {
            mova: {
                short: '–î–æ–¥–∞—Ç–∏ –∑–∞–¥–∞—á—É: –ü–æ–¥–∞—Ç–∏ –∑–≤—ñ—Ç –¥–æ 15:00 –∑–∞–≤—Ç—Ä–∞',
                full: `–î–æ–¥–∞—Ç–∏ –∑–∞–¥–∞—á—É: –ü–æ–¥–∞—Ç–∏ –∑–≤—ñ—Ç –¥–æ 15:00 –∑–∞–≤—Ç—Ä–∞

–ù–∞–º—ñ—Ä: —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –∑–∞–¥–∞—á—É –∑ –æ–ø–∏—Å–æ–º —ñ —Ç–µ—Ä–º—ñ–Ω–æ–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.
–ö–æ–Ω—Ç–µ–∫—Å—Ç: —â–æ–¥–µ–Ω–Ω–µ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è, –≤–∞–∂–ª–∏–≤–∏–π –∑–≤—ñ—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥–∏.
–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–¥–∞—á–∞ –¥–æ–¥–∞–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Ç–µ—Ä–º—ñ–Ω–æ–º.`
            },
            jalm: {
                short: '{"–Ω–∞–º—ñ—Ä":"—Å—Ç–≤–æ—Ä–∏—Ç–∏_–∑–∞–¥–∞—á—É","–æ–ø–∏—Å":"–ü–æ–¥–∞—Ç–∏ –∑–≤—ñ—Ç"}',
                full: JSON.stringify({
                    "–Ω–∞–º—ñ—Ä": "—Å—Ç–≤–æ—Ä–∏—Ç–∏_–∑–∞–¥–∞—á—É",
                    "–ø–∞—Ä–∞–º–µ—Ç—Ä–∏": {
                        "–æ–ø–∏—Å": "–ü–æ–¥–∞—Ç–∏ –∑–≤—ñ—Ç",
                        "—Ç–µ—Ä–º—ñ–Ω": "2024-07-26 15:00",
                        "–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç": "–≤–∏—Å–æ–∫–∏–π",
                        "—Ç–µ–≥–∏": ["–∑–≤—ñ—Ç", "–∫–æ–º–∞–Ω–¥–∞", "—Ç–µ—Ä–º—ñ–Ω–æ–≤–æ"]
                    },
                    "–∫–æ–Ω—Ç–µ–∫—Å—Ç": {
                        "–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á": "user123",
                        "—á–∞—Å_—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è": "2024-07-25T23:59:00Z"
                    }
                }, null, 2)
            },
            code: {
                short: 'create_task("–ü–æ–¥–∞—Ç–∏ –∑–≤—ñ—Ç", "2024-07-26 15:00")',
                full: `def create_task(description, due_date, priority="medium", tags=None):
    """
    –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –∑–∞–¥–∞—á—É –≤ —Å–∏—Å—Ç–µ–º—ñ Todoist

    Args:
        description (str): –û–ø–∏—Å –∑–∞–¥–∞—á—ñ
        due_date (str): –î–∞—Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ YYYY-MM-DD HH:MM
        priority (str): –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á—ñ (low/medium/high)
        tags (list): –°–ø–∏—Å–æ–∫ —Ç–µ–≥—ñ–≤

    Returns:
        dict: –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ ID –Ω–æ–≤–æ—ó –∑–∞–¥–∞—á—ñ
    """
    import requests
    import json
    from datetime import datetime

    # –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∞—Ç–∏
    due_datetime = datetime.strptime(due_date, "%Y-%m-%d %H:%M")

    # –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö
    task_data = {
        "content": description,
        "due_datetime": due_datetime.isoformat(),
        "priority": priority_map[priority],
        "labels": tags or []
    }

    # –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É
    response = requests.post(
        "https://api.todoist.com/rest/v2/tasks",
        headers={"Authorization": f"Bearer {API_TOKEN}"},
        json=task_data
    )

    return response.json()`
            },
            log: {
                short: '[23:59] –ó–∞–ø–∏—Ç –≤–∏–∫–æ–Ω–∞–Ω–æ',
                full: `[23:59:15] –ü–æ—á–∞—Ç–æ–∫ –æ–±—Ä–æ–±–∫–∏ –Ω–∞–º—ñ—Ä—É: —Å—Ç–≤–æ—Ä–∏—Ç–∏_–∑–∞–¥–∞—á—É
[23:59:16] –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤: —É—Å–ø—ñ—à–Ω–æ
[23:59:17] –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Todoist API
[23:59:18] –í—ñ–¥–ø—Ä–∞–≤–∫–∞ POST /rest/v2/tasks
[23:59:19] –û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: 200 OK
[23:59:20] –ó–∞–¥–∞—á–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞ –∑ ID: 123456789
[23:59:21] –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ª–æ–∫–∞–ª—å–Ω—ñ–π –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
[23:59:22] –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ`
            },
            error: {
                short: '[–ü–û–ú–ò–õ–ö–ê] –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∏',
                full: `Traceback (most recent call last):
  File "/app/mova_handler.py", line 45, in process_intent
    task_id = create_task(description, due_date)
  File "/app/todoist_api.py", line 23, in create_task
    due_datetime = datetime.strptime(due_date, "%Y-%m-%d %H:%M")
ValueError: time data '–∑–∞–≤—Ç—Ä–∞ 15:00' does not match format '%Y-%m-%d %H:%M'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/app/main.py", line 78, in handle_request
    result = process_intent(intent_data)
  File "/app/mova_handler.py", line 52, in process_intent
    raise IntentProcessingError(f"Failed to create task: {str(e)}")
IntentProcessingError: Failed to create task: time data '–∑–∞–≤—Ç—Ä–∞ 15:00' does not match format '%Y-%m-%d %H:%M'`
            }
        };

        let activeLayers = [];
        let currentData = null;
        let searchQuery = '';
        let layerFilter = '';
        let viewHistory = [];

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ–º–æ –¥–∞–Ω–∏—Ö
        function loadDemoData() {
            currentData = capsule;
            updateDisplay();
            addToHistory('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –¥–µ–º–æ –¥–∞–Ω—ñ');
            
            // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫
            const loadDemoBtn = document.getElementById('loadDemo');
            const loadFromFileBtn = document.getElementById('loadFromFile');
            const loadFromAPIBtn = document.getElementById('loadFromAPI');
            
            if (loadDemoBtn) loadDemoBtn.disabled = false;
            if (loadFromFileBtn) loadFromFileBtn.disabled = false;
            if (loadFromAPIBtn) loadFromAPIBtn.disabled = false;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ —Ñ–∞–π–ª—É
        function loadFromFile() {
            document.getElementById('fileInput').click();
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ API
        async function loadFromAPI() {
            try {
                const response = await fetch('/api/capsule/latest');
                if (response.ok) {
                    currentData = await response.json();
                    updateDisplay();
                    addToHistory('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ API');
                    
                    // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫
                    const loadFromFileBtn = document.getElementById('loadFromFile');
                    const loadFromAPIBtn = document.getElementById('loadFromAPI');
                    if (loadFromFileBtn) loadFromFileBtn.disabled = false;
                    if (loadFromAPIBtn) loadFromAPIBtn.disabled = false;
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ API: ' + response.statusText);
                }
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ API: ' + error.message);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É Python —Ñ–∞–π–ª—É
        function analyzePythonFile(content) {
            const lines = content.split('\n');
            const result = {
                mova: { short: '', full: '' },
                jalm: { short: '', full: '' },
                code: { short: '', full: '' },
                log: { short: '', full: '' },
                error: { short: '', full: '' }
            };
            
            let codeLines = [];
            let logLines = [];
            let errorLines = [];
            let movaLines = [];
            let jalmLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // MOVA: –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –¥–æ—Å–≤—ñ–¥
                if (trimmedLine.includes('app.route') || 
                    trimmedLine.includes('send_from_directory') ||
                    trimmedLine.includes('jsonify') ||
                    trimmedLine.includes('request') ||
                    trimmedLine.includes('render_template') ||
                    trimmedLine.includes('redirect') ||
                    trimmedLine.includes('url_for') ||
                    trimmedLine.includes('flash') ||
                    trimmedLine.includes('session') ||
                    trimmedLine.includes('cookies') ||
                    trimmedLine.includes('headers') ||
                    trimmedLine.includes('user-agent') ||
                    trimmedLine.includes('content-type') ||
                    trimmedLine.includes('cors') ||
                    trimmedLine.includes('static') ||
                    trimmedLine.includes('templates')) {
                    movaLines.push(line);
                }
                // JALM: –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ —Ç–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–∏
                else if (trimmedLine.includes('def ') && 
                        (trimmedLine.includes('validate') || 
                         trimmedLine.includes('process') || 
                         trimmedLine.includes('calculate') || 
                         trimmedLine.includes('transform') || 
                         trimmedLine.includes('parse') || 
                         trimmedLine.includes('format') || 
                         trimmedLine.includes('convert') || 
                         trimmedLine.includes('generate') || 
                         trimmedLine.includes('create') || 
                         trimmedLine.includes('update') || 
                         trimmedLine.includes('delete') || 
                         trimmedLine.includes('search') || 
                         trimmedLine.includes('filter') || 
                         trimmedLine.includes('sort'))) {
                    jalmLines.push(line);
                }
                // –õ–æ–≥–∏
                else if (trimmedLine.includes('print(') || 
                         trimmedLine.includes('logging.') || 
                         trimmedLine.includes('logger.') ||
                         trimmedLine.includes('console.log') ||
                         trimmedLine.includes('debug') ||
                         trimmedLine.includes('info') ||
                         trimmedLine.includes('warning')) {
                    logLines.push(line);
                }
                // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
                else if (trimmedLine.includes('except') || 
                         trimmedLine.includes('raise') || 
                         trimmedLine.includes('error') || 
                         trimmedLine.includes('Error') ||
                         trimmedLine.includes('try:') ||
                         trimmedLine.includes('finally:') ||
                         trimmedLine.includes('return jsonify({"error":') ||
                         trimmedLine.includes('return jsonify({"success": false') ||
                         trimmedLine.includes('status_code') ||
                         trimmedLine.includes('HTTPException')) {
                    errorLines.push(line);
                }
                // –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥
                else if (trimmedLine.length > 0) {
                    codeLines.push(line);
                }
            }
            
            // –§–æ—Ä–º—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑ –∫—Ä–∞—â–∏–º–∏ –æ–ø–∏—Åami
            result.mova.short = movaLines.length > 0 ? 
                `MOVA —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å (${movaLines.length} —Ä—è–¥–∫—ñ–≤)` : '–ù–µ–º–∞—î MOVA –¥–∞–Ω–∏—Ö';
            result.mova.full = movaLines.join('\n') || '–ù–µ–º–∞—î MOVA –¥–∞–Ω–∏—Ö';
            
            result.jalm.short = jalmLines.length > 0 ? 
                `JALM –ª–æ–≥—ñ–∫–∞ (${jalmLines.length} —Ä—è–¥–∫—ñ–≤)` : '–ù–µ–º–∞—î JALM –¥–∞–Ω–∏—Ö';
            result.jalm.full = jalmLines.join('\n') || '–ù–µ–º–∞—î JALM –¥–∞–Ω–∏—Ö';
            
            result.code.short = codeLines.length > 0 ? 
                `Python –∫–æ–¥ (${codeLines.length} —Ä—è–¥–∫—ñ–≤)` : '–ù–µ–º–∞—î –∫–æ–¥—É';
            result.code.full = codeLines.join('\n') || '–ù–µ–º–∞—î –∫–æ–¥—É';
            
            result.log.short = logLines.length > 0 ? 
                `–õ–æ–≥–∏ (${logLines.length} —Ä—è–¥–∫—ñ–≤)` : '–ù–µ–º–∞—î –ª–æ–≥—ñ–≤';
            result.log.full = logLines.join('\n') || '–ù–µ–º–∞—î –ª–æ–≥—ñ–≤';
            
            result.error.short = errorLines.length > 0 ? 
                `–û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ (${errorLines.length} —Ä—è–¥–∫—ñ–≤)` : '–ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫';
            result.error.full = errorLines.join('\n') || '–ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫';
            
            return result;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Ñ–∞–π–ª—ñ–≤ –∑–∞ –º–æ–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
        function analyzeFileByLanguage(content, filename) {
            const extension = filename.split('.').pop().toLowerCase();
            
            switch (extension) {
                case 'py':
                    return analyzePythonFile(content);
                case 'js':
                case 'ts':
                    return analyzeJavaScriptFile(content);
                case 'json':
                    return analyzeJsonFile(content);
                case 'html':
                    return analyzeHtmlFile(content);
                case 'css':
                    return analyzeCssFile(content);
                case 'md':
                    return analyzeMarkdownFile(content);
                case 'xml':
                case 'yaml':
                case 'yml':
                    return analyzeConfigFile(content, extension);
                default:
                    return analyzeGenericFile(content);
            }
        }

        function analyzeJavaScriptFile(content) {
            const lines = content.split('\n');
            const movaLines = [];
            const jalmLines = [];
            const codeLines = [];
            const logLines = [];
            const errorLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // MOVA - DOM manipulation, event handlers, API calls
                if (trimmedLine.includes('document.') ||
                    trimmedLine.includes('addEventListener') ||
                    trimmedLine.includes('fetch(') ||
                    trimmedLine.includes('XMLHttpRequest') ||
                    trimmedLine.includes('querySelector') ||
                    trimmedLine.includes('getElementById') ||
                    trimmedLine.includes('innerHTML') ||
                    trimmedLine.includes('style.') ||
                    trimmedLine.includes('classList.') ||
                    trimmedLine.includes('appendChild') ||
                    trimmedLine.includes('removeChild') ||
                    trimmedLine.includes('createElement')) {
                    movaLines.push(line);
                }
                // JALM - business logic functions
                else if (trimmedLine.includes('function ') && (
                    trimmedLine.includes('validate') ||
                    trimmedLine.includes('process') ||
                    trimmedLine.includes('calculate') ||
                    trimmedLine.includes('transform') ||
                    trimmedLine.includes('parse') ||
                    trimmedLine.includes('format') ||
                    trimmedLine.includes('convert') ||
                    trimmedLine.includes('generate') ||
                    trimmedLine.includes('create') ||
                    trimmedLine.includes('update') ||
                    trimmedLine.includes('delete') ||
                    trimmedLine.includes('search') ||
                    trimmedLine.includes('filter') ||
                    trimmedLine.includes('sort'))) {
                    jalmLines.push(line);
                }
                // CODE - general code
                else if (trimmedLine.includes('function ') || 
                         trimmedLine.includes('const ') ||
                         trimmedLine.includes('let ') ||
                         trimmedLine.includes('var ') ||
                         trimmedLine.includes('if ') ||
                         trimmedLine.includes('for ') ||
                         trimmedLine.includes('while ') ||
                         trimmedLine.includes('try {') ||
                         trimmedLine.includes('catch') ||
                         trimmedLine.includes('return ') ||
                         trimmedLine.includes('=') ||
                         trimmedLine.includes('(') ||
                         trimmedLine.includes('[') ||
                         trimmedLine.includes('{')) {
                    codeLines.push(line);
                }
                // LOG - console statements
                else if (trimmedLine.includes('console.log') || 
                         trimmedLine.includes('console.info') ||
                         trimmedLine.includes('console.warn') ||
                         trimmedLine.includes('console.error') ||
                         trimmedLine.includes('alert(') ||
                         trimmedLine.includes('log(') ||
                         trimmedLine.includes('info(') ||
                         trimmedLine.includes('warn(') ||
                         trimmedLine.includes('error(')) {
                    logLines.push(line);
                }
                // ERROR - error handling
                else if (trimmedLine.includes('catch') || 
                         trimmedLine.includes('throw ') ||
                         trimmedLine.includes('Error') ||
                         trimmedLine.includes('Exception') ||
                         trimmedLine.includes('reject') ||
                         trimmedLine.includes('error')) {
                    errorLines.push(line);
                }
                // Comments and empty lines
                else if (trimmedLine.startsWith('//') || trimmedLine.startsWith('/*') || trimmedLine === '') {
                    // Skip comments and empty lines
                }
                // Everything else goes to CODE
                else {
                    codeLines.push(line);
                }
            }

            return {
                mova: {
                    short: `MOVA —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å (${movaLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: movaLines.join('\n')
                },
                jalm: {
                    short: `JALM –ª–æ–≥—ñ–∫–∞ (${jalmLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: jalmLines.join('\n')
                },
                code: {
                    short: `JavaScript –∫–æ–¥ (${codeLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: codeLines.join('\n')
                },
                log: {
                    short: `–õ–æ–≥–∏ (${logLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: logLines.join('\n')
                },
                error: {
                    short: `–û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ (${errorLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: errorLines.join('\n')
                }
            };
        }

        function analyzeJsonFile(content) {
            try {
                const data = JSON.parse(content);
                const jsonStr = JSON.stringify(data, null, 2);
                const lines = jsonStr.split('\n');
                
                return {
                    mova: {
                        short: `JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (${lines.length} —Ä—è–¥–∫—ñ–≤)`,
                        full: jsonStr
                    },
                    jalm: {
                        short: `–î–∞–Ω—ñ (${Object.keys(data).length} –∫–ª—é—á—ñ–≤)`,
                        full: JSON.stringify(data, null, 2)
                    },
                    code: {
                        short: `–°—Ö–µ–º–∞ JSON`,
                        full: generateJsonSchema(data)
                    },
                    log: {
                        short: `–í–∞–ª—ñ–¥–∞—Ü—ñ—è`,
                        full: validateJson(data)
                    },
                    error: {
                        short: `–ü–æ–º–∏–ª–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥—É`,
                        full: ''
                    }
                };
            } catch (e) {
                return {
                    mova: {
                        short: `JSON —Ñ–∞–π–ª`,
                        full: content
                    },
                    jalm: {
                        short: `–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É`,
                        full: e.message
                    },
                    code: {
                        short: `–°—Ç—Ä—É–∫—Ç—É—Ä–∞`,
                        full: content
                    },
                    log: {
                        short: `–õ–æ–≥–∏`,
                        full: ''
                    },
                    error: {
                        short: `–ü–æ–º–∏–ª–∫–∞: ${e.message}`,
                        full: e.stack
                    }
                };
            }
        }

        function analyzeHtmlFile(content) {
            const lines = content.split('\n');
            const movaLines = [];
            const jalmLines = [];
            const codeLines = [];
            const logLines = [];
            const errorLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // MOVA - HTML structure, forms, links
                if (trimmedLine.includes('<html') ||
                    trimmedLine.includes('<head') ||
                    trimmedLine.includes('<body') ||
                    trimmedLine.includes('<form') ||
                    trimmedLine.includes('<input') ||
                    trimmedLine.includes('<button') ||
                    trimmedLine.includes('<a ') ||
                    trimmedLine.includes('<div') ||
                    trimmedLine.includes('<span') ||
                    trimmedLine.includes('<p>') ||
                    trimmedLine.includes('<h1') ||
                    trimmedLine.includes('<h2') ||
                    trimmedLine.includes('<h3')) {
                    movaLines.push(line);
                }
                // JALM - JavaScript in HTML
                else if (trimmedLine.includes('<script') ||
                         trimmedLine.includes('function ') ||
                         trimmedLine.includes('const ') ||
                         trimmedLine.includes('let ') ||
                         trimmedLine.includes('var ')) {
                    jalmLines.push(line);
                }
                // CODE - CSS, meta tags, other elements
                else if (trimmedLine.includes('<style') ||
                         trimmedLine.includes('<link') ||
                         trimmedLine.includes('<meta') ||
                         trimmedLine.includes('<title') ||
                         trimmedLine.includes('class=') ||
                         trimmedLine.includes('id=') ||
                         trimmedLine.includes('style=')) {
                    codeLines.push(line);
                }
                // LOG - comments
                else if (trimmedLine.includes('<!--') ||
                         trimmedLine.includes('-->')) {
                    logLines.push(line);
                }
                // ERROR - broken tags
                else if (trimmedLine.includes('<') && !trimmedLine.includes('>')) {
                    errorLines.push(line);
                }
                // Everything else
                else {
                    codeLines.push(line);
                }
            }

            return {
                mova: {
                    short: `HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (${movaLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: movaLines.join('\n')
                },
                jalm: {
                    short: `JavaScript (${jalmLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: jalmLines.join('\n')
                },
                code: {
                    short: `CSS —Ç–∞ –º–µ—Ç–∞-—Ç–µ–≥–∏ (${codeLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: codeLines.join('\n')
                },
                log: {
                    short: `–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ (${logLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: logLines.join('\n')
                },
                error: {
                    short: `–ü–æ–º–∏–ª–∫–∏ HTML (${errorLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: errorLines.join('\n')
                }
            };
        }

        function analyzeCssFile(content) {
            const lines = content.split('\n');
            const movaLines = [];
            const jalmLines = [];
            const codeLines = [];
            const logLines = [];
            const errorLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // MOVA - layout and positioning
                if (trimmedLine.includes('display:') ||
                    trimmedLine.includes('position:') ||
                    trimmedLine.includes('flex') ||
                    trimmedLine.includes('grid') ||
                    trimmedLine.includes('margin:') ||
                    trimmedLine.includes('padding:') ||
                    trimmedLine.includes('width:') ||
                    trimmedLine.includes('height:')) {
                    movaLines.push(line);
                }
                // JALM - animations and transitions
                else if (trimmedLine.includes('animation:') ||
                         trimmedLine.includes('transition:') ||
                         trimmedLine.includes('transform:') ||
                         trimmedLine.includes('@keyframes') ||
                         trimmedLine.includes('hover') ||
                         trimmedLine.includes('active')) {
                    jalmLines.push(line);
                }
                // CODE - general styles
                else if (trimmedLine.includes('{') ||
                         trimmedLine.includes('}') ||
                         trimmedLine.includes(':') ||
                         trimmedLine.includes(';')) {
                    codeLines.push(line);
                }
                // LOG - comments
                else if (trimmedLine.includes('/*') ||
                         trimmedLine.includes('*/')) {
                    logLines.push(line);
                }
                // ERROR - invalid CSS
                else if (trimmedLine.includes(';') && !trimmedLine.includes(':')) {
                    errorLines.push(line);
                }
                // Everything else
                else {
                    codeLines.push(line);
                }
            }

            return {
                mova: {
                    short: `CSS layout (${movaLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: movaLines.join('\n')
                },
                jalm: {
                    short: `CSS –∞–Ω—ñ–º–∞—Ü—ñ—ó (${jalmLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: jalmLines.join('\n')
                },
                code: {
                    short: `CSS —Å—Ç–∏–ª—ñ (${codeLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: codeLines.join('\n')
                },
                log: {
                    short: `CSS –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ (${logLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: logLines.join('\n')
                },
                error: {
                    short: `CSS –ø–æ–º–∏–ª–∫–∏ (${errorLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: errorLines.join('\n')
                }
            };
        }

        function analyzeMarkdownFile(content) {
            const lines = content.split('\n');
            const movaLines = [];
            const jalmLines = [];
            const codeLines = [];
            const logLines = [];
            const errorLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // MOVA - headers and structure
                if (trimmedLine.startsWith('#') ||
                    trimmedLine.startsWith('##') ||
                    trimmedLine.startsWith('###') ||
                    trimmedLine.includes('[') && trimmedLine.includes('](') ||
                    trimmedLine.includes('![')) {
                    movaLines.push(line);
                }
                // JALM - code blocks
                else if (trimmedLine.includes('```') ||
                         trimmedLine.includes('`') ||
                         trimmedLine.includes('    ')) {
                    jalmLines.push(line);
                }
                // CODE - lists and formatting
                else if (trimmedLine.startsWith('- ') ||
                         trimmedLine.startsWith('* ') ||
                         trimmedLine.startsWith('1. ') ||
                         trimmedLine.includes('**') ||
                         trimmedLine.includes('*') ||
                         trimmedLine.includes('>')) {
                    codeLines.push(line);
                }
                // LOG - comments
                else if (trimmedLine.includes('<!--') ||
                         trimmedLine.includes('-->')) {
                    logLines.push(line);
                }
                // ERROR - broken markdown
                else if (trimmedLine.includes('[') && !trimmedLine.includes(']')) {
                    errorLines.push(line);
                }
                // Everything else
                else {
                    codeLines.push(line);
                }
            }

            return {
                mova: {
                    short: `Markdown —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (${movaLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: movaLines.join('\n')
                },
                jalm: {
                    short: `–ö–æ–¥ –±–ª–æ–∫–∏ (${jalmLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: jalmLines.join('\n')
                },
                code: {
                    short: `–§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è (${codeLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: codeLines.join('\n')
                },
                log: {
                    short: `–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ (${logLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: logLines.join('\n')
                },
                error: {
                    short: `–ü–æ–º–∏–ª–∫–∏ Markdown (${errorLines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: errorLines.join('\n')
                }
            };
        }

        function analyzeConfigFile(content, extension) {
            const lines = content.split('\n');
            
            return {
                mova: {
                    short: `${extension.toUpperCase()} –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è`,
                    full: content
                },
                jalm: {
                    short: `–ü–∞—Ä–∞–º–µ—Ç—Ä–∏`,
                    full: content
                },
                code: {
                    short: `–°—Ç—Ä—É–∫—Ç—É—Ä–∞`,
                    full: content
                },
                log: {
                    short: `–õ–æ–≥–∏`,
                    full: ''
                },
                error: {
                    short: `–ü–æ–º–∏–ª–∫–∏`,
                    full: ''
                }
            };
        }

        function analyzeGenericFile(content) {
            const lines = content.split('\n');
            
            return {
                mova: {
                    short: `–§–∞–π–ª (${lines.length} —Ä—è–¥–∫—ñ–≤)`,
                    full: content
                },
                jalm: {
                    short: `–î–∞–Ω—ñ`,
                    full: content
                },
                code: {
                    short: `–°—Ç—Ä—É–∫—Ç—É—Ä–∞`,
                    full: content
                },
                log: {
                    short: `–õ–æ–≥–∏`,
                    full: ''
                },
                error: {
                    short: `–ü–æ–º–∏–ª–∫–∏`,
                    full: ''
                }
            };
        }

        function generateJsonSchema(data) {
            // –ü—Ä–æ—Å—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å—Ö–µ–º–∏ JSON
            const schema = {};
            for (const key in data) {
                const value = data[key];
                schema[key] = typeof value;
            }
            return JSON.stringify(schema, null, 2);
        }

        function validateJson(data) {
            // –ü—Ä–æ—Å—Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è JSON
            const errors = [];
            if (typeof data !== 'object') {
                errors.push('–ö–æ—Ä–µ–Ω–µ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –æ–±\'—î–∫—Ç–æ–º');
            }
            return errors.length > 0 ? errors.join('\n') : 'JSON –≤–∞–ª—ñ–¥–Ω–∏–π';
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–≤–∏ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É
        function getLanguageForLayer(layer) {
            // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó
            const currentFile = window.currentFileName || '';
            const extension = currentFile.split('.').pop().toLowerCase();
            
            // –ë–∞–∑–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è —à–∞—Ä—ñ–≤
            const baseLanguages = {
                'jalm': 'json',
                'code': 'python',
                'log': 'log',
                'error': 'text',
                'mova': 'python'
            };
            
            // –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤ —Ñ–∞–π–ª—ñ–≤
            const fileTypeLanguages = {
                'js': {
                    'mova': 'javascript',
                    'jalm': 'javascript',
                    'code': 'javascript',
                    'log': 'javascript',
                    'error': 'javascript'
                },
                'ts': {
                    'mova': 'typescript',
                    'jalm': 'typescript',
                    'code': 'typescript',
                    'log': 'typescript',
                    'error': 'typescript'
                },
                'html': {
                    'mova': 'html',
                    'jalm': 'javascript',
                    'code': 'css',
                    'log': 'html',
                    'error': 'html'
                },
                'css': {
                    'mova': 'css',
                    'jalm': 'css',
                    'code': 'css',
                    'log': 'css',
                    'error': 'css'
                },
                'md': {
                    'mova': 'markdown',
                    'jalm': 'markdown',
                    'code': 'markdown',
                    'log': 'markdown',
                    'error': 'markdown'
                },
                'json': {
                    'mova': 'json',
                    'jalm': 'json',
                    'code': 'json',
                    'log': 'json',
                    'error': 'json'
                },
                'xml': {
                    'mova': 'xml',
                    'jalm': 'xml',
                    'code': 'xml',
                    'log': 'xml',
                    'error': 'xml'
                },
                'yaml': {
                    'mova': 'yaml',
                    'jalm': 'yaml',
                    'code': 'yaml',
                    'log': 'yaml',
                    'error': 'yaml'
                },
                'yml': {
                    'mova': 'yaml',
                    'jalm': 'yaml',
                    'code': 'yaml',
                    'log': 'yaml',
                    'error': 'yaml'
                }
            };
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ç–∏–ø—É —Ñ–∞–π–ª—É
            if (fileTypeLanguages[extension] && fileTypeLanguages[extension][layer]) {
                return fileTypeLanguages[extension][layer];
            }
            
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –±–∞–∑–æ–≤—É –º–æ–≤—É –¥–ª—è —à–∞—Ä—É
            return baseLanguages[layer] || 'text';
        }

        // –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
        function handleFileUpload(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let processedData;
                        
                        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –∞–Ω–∞–ª—ñ–∑—É –∑–∞ –º–æ–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
                        const extension = file.name.split('.').pop().toLowerCase();
                        
                        if (['js', 'ts', 'html', 'css', 'md', 'xml', 'yaml', 'yml'].includes(extension)) {
                            // –ù–æ–≤—ñ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏
                            processedData = analyzeFileByLanguage(e.target.result, file.name);
                        } else if (file.name.endsWith('.py')) {
                            // Python —Ñ–∞–π–ª
                            processedData = analyzePythonFile(e.target.result);
                        } else if (file.name.endsWith('.json')) {
                            // JSON —Ñ–∞–π–ª
                            processedData = analyzeJsonFile(e.target.result);
                        } else {
                            // TXT –∞–±–æ —ñ–Ω—à—ñ —Ñ–∞–π–ª–∏
                            try {
                                const parsedData = JSON.parse(e.target.result);
                                
                                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–∏—Ö
                                if (!parsedData || typeof parsedData !== 'object') {
                                    throw new Error('–î–∞–Ω—ñ –Ω–µ —î –æ–±\'—î–∫—Ç–æ–º');
                                }
                                
                                // –Ø–∫—â–æ –¥–∞–Ω—ñ –ø—Ä–∏—Ö–æ–¥—è—Ç—å —è–∫ –º–∞—Å–∏–≤, –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ –æ–±'—î–∫—Ç
                                processedData = parsedData;
                                if (Array.isArray(parsedData)) {
                                    processedData = {
                                        mova: { short: 'MOVA –¥–∞–Ω—ñ', full: JSON.stringify(parsedData, null, 2) },
                                        jalm: { short: 'JALM –¥–∞–Ω—ñ', full: JSON.stringify(parsedData, null, 2) },
                                        code: { short: 'CODE –¥–∞–Ω—ñ', full: JSON.stringify(parsedData, null, 2) },
                                        log: { short: 'LOG –¥–∞–Ω—ñ', full: JSON.stringify(parsedData, null, 2) },
                                        error: { short: 'ERROR –¥–∞–Ω—ñ', full: JSON.stringify(parsedData, null, 2) }
                                    };
                                }
                            } catch (parseError) {
                                // –Ø–∫—â–æ –Ω–µ JSON, –æ–±—Ä–æ–±–ª—è—î–º–æ —è–∫ –∑–≤–∏—á–∞–π–Ω–∏–π —Ç–µ–∫—Å—Ç
                                processedData = analyzeGenericFile(e.target.result);
                            }
                        }
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö —à–∞—Ä—ñ–≤
                        const requiredLayers = ['mova', 'jalm', 'code', 'log', 'error'];
                        const missingLayers = requiredLayers.filter(layer => !processedData[layer]);
                        
                        if (missingLayers.length > 0) {
                            // –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑ –ø—É—Å—Ç–∏–º–∏ –¥–∞–Ω–∏–º–∏
                            missingLayers.forEach(layer => {
                                processedData[layer] = {
                                    short: `–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö ${layer.toUpperCase()}`,
                                    full: `–î–∞–Ω—ñ –¥–ª—è —à–∞—Ä—É ${layer} –≤—ñ–¥—Å—É—Ç–Ω—ñ`
                                };
                            });
                        }
                        
                        currentData = processedData;
                        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞–∑–≤—É —Ñ–∞–π–ª—É –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–≤–∏ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è
                        window.currentFileName = file.name;
                        addToHistory('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ —Ñ–∞–π–ª—É: ' + file.name);
                        updateDisplay();
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –º–µ—Ç—Ä–∏–∫–∏ —è–∫—â–æ –ø–∞–Ω–µ–ª—å –≤—ñ–¥–∫—Ä–∏—Ç–∞
                        const metricsPanel = document.getElementById('metricsPanel');
                        if (metricsPanel && metricsPanel.classList.contains('show')) {
                            displayMetrics();
                        }
                        
                        // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                        const loadFromFileBtn = document.getElementById('loadFromFile');
                        const loadFromAPIBtn = document.getElementById('loadFromAPI');
                        const fileInput = document.getElementById('fileInput');
                        
                        if (loadFromFileBtn) loadFromFileBtn.disabled = false;
                        if (loadFromAPIBtn) loadFromAPIBtn.disabled = false;
                        if (fileInput) fileInput.value = ''; // –°–∫–∏–¥–∞—î–º–æ file input
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —Ñ–∞–π–ª—É:', error);
                        alert('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —Ñ–∞–π–ª—É: ' + error.message);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É:', error);
                    alert('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É');
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–∞–π–ª—É:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–∞–π–ª—É: ' + error.message);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –µ–∫—Å–ø–æ—Ä—Ç—É –≤ JSON
        function exportToJSON() {
            if (!currentData) {
                alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É');
                return;
            }
            
            const dataStr = JSON.stringify(currentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `capsule_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // –§—É–Ω–∫—Ü—ñ—è –µ–∫—Å–ø–æ—Ä—Ç—É –≤ TXT
        function exportToTXT() {
            if (!currentData) {
                alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É');
                return;
            }
            
            let txtContent = 'ISKALA/MOVA Capsule Export\n';
            txtContent += '='.repeat(50) + '\n\n';
            
            Object.keys(currentData).forEach(layer => {
                const data = currentData[layer];
                txtContent += `${layer.toUpperCase()}:\n`;
                txtContent += '-'.repeat(20) + '\n';
                txtContent += `Short: ${data.short}\n`;
                txtContent += `Full: ${data.full}\n\n`;
            });
            
            const dataBlob = new Blob([txtContent], {type: 'text/plain'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `capsule_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // –§—É–Ω–∫—Ü—ñ—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –º–µ—Ç—Ä–∏–∫ –∫–æ–¥—É
        function calculateMetrics() {
            if (!currentData) return null;
            
            const metrics = {
                totalLines: 0,
                totalFunctions: 0,
                totalClasses: 0,
                totalImports: 0,
                complexity: 0,
                layers: {}
            };
            
            // –ê–Ω–∞–ª—ñ–∑—É—î–º–æ –∫–æ–∂–µ–Ω —à–∞—Ä
            Object.keys(currentData).forEach(layer => {
                const data = currentData[layer];
                if (!data || !data.full) return;
                
                const lines = data.full.split('\n').filter(line => line.trim().length > 0);
                const layerMetrics = {
                    lines: lines.length,
                    characters: data.full.length,
                    functions: (data.full.match(/def\s+\w+/g) || []).length,
                    classes: (data.full.match(/class\s+\w+/g) || []).length,
                    imports: (data.full.match(/import\s+|from\s+/g) || []).length,
                    complexity: calculateComplexity(data.full)
                };
                
                metrics.layers[layer] = layerMetrics;
                metrics.totalLines += layerMetrics.lines;
                metrics.totalFunctions += layerMetrics.functions;
                metrics.totalClasses += layerMetrics.classes;
                metrics.totalImports += layerMetrics.imports;
                metrics.complexity += layerMetrics.complexity;
            });
            
            return metrics;
        }

        // –§—É–Ω–∫—Ü—ñ—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ –∫–æ–¥—É
        function calculateComplexity(code) {
            let complexity = 0;
            
            // –î–æ–¥–∞—î–º–æ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –∑–∞ —Ä—ñ–∑–Ω—ñ –ø–∞—Ç–µ—Ä–Ω–∏
            complexity += (code.match(/if\s+/g) || []).length;
            complexity += (code.match(/for\s+/g) || []).length;
            complexity += (code.match(/while\s+/g) || []).length;
            complexity += (code.match(/try\s*:/g) || []).length;
            complexity += (code.match(/except\s+/g) || []).length;
            complexity += (code.match(/def\s+/g) || []).length * 2; // –§—É–Ω–∫—Ü—ñ—ó –¥–æ–¥–∞—é—Ç—å —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
            complexity += (code.match(/class\s+/g) || []).length * 3; // –ö–ª–∞—Å–∏ –¥–æ–¥–∞—é—Ç—å –±—ñ–ª—å—à–µ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ
            
            return complexity;
        }

        // –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–µ—Ç—Ä–∏–∫
        function displayMetrics() {
            const metrics = calculateMetrics();
            if (!metrics) return;
            
            const metricsGrid = document.getElementById('metricsGrid');
            const layerMetrics = document.getElementById('layerMetrics');
            
            // –ó–∞–≥–∞–ª—å–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalLines}</div>
                    <div class="metric-label">–í—Å—å–æ–≥–æ —Ä—è–¥–∫—ñ–≤</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalFunctions}</div>
                    <div class="metric-label">–§—É–Ω–∫—Ü—ñ–π</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalClasses}</div>
                    <div class="metric-label">–ö–ª–∞—Å—ñ–≤</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalImports}</div>
                    <div class="metric-label">–Ü–º–ø–æ—Ä—Ç—ñ–≤</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.complexity}</div>
                    <div class="metric-label">–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${Object.keys(metrics.layers).length}</div>
                    <div class="metric-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö —à–∞—Ä—ñ–≤</div>
                </div>
            `;
            
            // –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ —à–∞—Ä–∞—Ö
            layerMetrics.innerHTML = '';
            Object.keys(metrics.layers).forEach(layer => {
                const layerData = metrics.layers[layer];
                const layerName = layer.toUpperCase();
                
                layerMetrics.innerHTML += `
                    <div class="layer-metric ${layer}">
                        <div class="layer-metric-value">${layerData.lines}</div>
                        <div class="layer-metric-label">${layerName} (—Ä—è–¥–∫—ñ–≤)</div>
                    </div>
                `;
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø–∞–Ω–µ–ª—ñ –º–µ—Ç—Ä–∏–∫
        function toggleMetrics() {
            console.log('toggleMetrics –≤–∏–∫–ª–∏–∫–∞–Ω–æ');
            alert('–ö–Ω–æ–ø–∫–∞ –º–µ—Ç—Ä–∏–∫ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞!'); // –¢–µ—Å—Ç–æ–≤–∏–π alert
            
            const panel = document.getElementById('metricsPanel');
            const button = document.querySelector('.metrics-toggle');
            
            console.log('panel:', panel);
            console.log('button:', button);
            
            if (panel && panel.classList.contains('show')) {
                panel.classList.remove('show');
                if (button) button.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏';
            } else if (panel) {
                panel.classList.add('show');
                if (button) button.textContent = '–°—Ö–æ–≤–∞—Ç–∏';
                displayMetrics();
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –æ—á–∏—â–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
        function clearData() {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ?')) {
                currentData = null;
                updateDisplay();
                addToHistory('–î–∞–Ω—ñ –æ—á–∏—â–µ–Ω–æ');
                
                // –°–∫–∏–¥–∞—î–º–æ file input
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveToServer() {
            if (!currentData) {
                alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
                return;
            }
            
            try {
                const response = await fetch('/api/capsule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`–ö–∞–ø—Å—É–ª–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ: ${result.filename}`);
                    addToHistory('–ó–±–µ—Ä–µ–∂–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
                } else {
                    const error = await response.json();
                    alert(`–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${error.error}`);
                }
            } catch (error) {
                alert(`–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –µ–∫—Å–ø–æ—Ä—Ç—É –≤ Python
        function exportToPython() {
            if (!currentData) {
                alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É');
                return;
            }
            
            let pyContent = '#!/usr/bin/env python3\n';
            pyContent += '# -*- coding: utf-8 -*-\n';
            pyContent += '"""\n';
            pyContent += 'ISKALA/MOVA Capsule Export\n';
            pyContent += '–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∑ ISKALA/MOVA Viewer\n';
            pyContent += '"""\n\n';
            
            // –î–æ–¥–∞—î–º–æ MOVA –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ
            if (currentData.mova && currentData.mova.full && currentData.mova.full !== '–ù–µ–º–∞—î MOVA –¥–∞–Ω–∏—Ö') {
                pyContent += '# MOVA —Å–µ–∫—Ü—ñ—è\n';
                pyContent += currentData.mova.full + '\n\n';
            }
            
            // –î–æ–¥–∞—î–º–æ JALM –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ
            if (currentData.jalm && currentData.jalm.full && currentData.jalm.full !== '–ù–µ–º–∞—î JALM –¥–∞–Ω–∏—Ö') {
                pyContent += '# JALM —Å–µ–∫—Ü—ñ—è\n';
                pyContent += currentData.jalm.full + '\n\n';
            }
            
            // –î–æ–¥–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥
            if (currentData.code && currentData.code.full && currentData.code.full !== '–ù–µ–º–∞—î –∫–æ–¥—É') {
                pyContent += '# CODE —Å–µ–∫—Ü—ñ—è\n';
                pyContent += currentData.code.full + '\n\n';
            }
            
            // –î–æ–¥–∞—î–º–æ –ª–æ–≥–∏
            if (currentData.log && currentData.log.full && currentData.log.full !== '–ù–µ–º–∞—î –ª–æ–≥—ñ–≤') {
                pyContent += '# LOG —Å–µ–∫—Ü—ñ—è\n';
                pyContent += currentData.log.full + '\n\n';
            }
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫
            if (currentData.error && currentData.error.full && currentData.error.full !== '–ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫') {
                pyContent += '# ERROR —Å–µ–∫—Ü—ñ—è\n';
                pyContent += currentData.error.full + '\n\n';
            }
            
            const dataBlob = new Blob([pyContent], {type: 'text/plain'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `capsule_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.py`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // –§—É–Ω–∫—Ü—ñ—è –ø–æ—à—É–∫—É
        function performSearch() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase();
            updateDisplay();
        }

        // –§—É–Ω–∫—Ü—ñ—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –ø–æ —à–∞—Ä–∞—Ö
        function performFilter() {
            layerFilter = document.getElementById('layerFilter').value;
            updateDisplay();
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó
        function addToHistory(action) {
            viewHistory.push({
                action: action,
                timestamp: new Date().toISOString(),
                layers: [...activeLayers]
            });
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 10 –¥—ñ–π
            if (viewHistory.length > 10) {
                viewHistory.shift();
            }
        }

        function toggleLayer(layer) {
            const index = activeLayers.indexOf(layer);
            if (index > -1) {
                activeLayers.splice(index, 1);
            } else {
                activeLayers.push(layer);
            }
            updateDisplay();
            updateLayerButtons();
        }

        function updateLayerButtons() {
            document.querySelectorAll('.layer-square').forEach(btn => {
                const layer = btn.dataset.layer;
                btn.classList.toggle('active', activeLayers.includes(layer));
            });
        }

        function toggleExpand(layer) {
            const content = document.getElementById(`content-${layer}`);
            const btn = document.getElementById(`expand-${layer}`);

            content.classList.toggle('expanded');
            btn.classList.toggle('expanded');
            btn.textContent = content.classList.contains('expanded') ? '‚ñæ' : '‚ñ∏';
        }

        function updateDisplay() {
            
            const mainContent = document.getElementById('mainContent');
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ toolbar —Ç–∞ searchBar —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î
            const toolbarHtml = `
                <div class="toolbar">
                    <button id="loadDemo" class="toolbar-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–µ–º–æ</button>
                    <button id="loadFromFile" class="toolbar-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ —Ñ–∞–π–ª—É</button>
                    <button id="loadFromAPI" class="toolbar-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ API</button>
                    <button id="exportJSON" class="toolbar-btn">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
                    <button id="exportTXT" class="toolbar-btn">–ï–∫—Å–ø–æ—Ä—Ç TXT</button>
                    <button id="exportPY" class="toolbar-btn">–ï–∫—Å–ø–æ—Ä—Ç Python</button>
                    <button id="saveToServer" class="toolbar-btn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
                    <button id="clearData" class="toolbar-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
                    <button id="showMetrics" class="toolbar-btn" onclick="toggleMetrics()">üìä –ú–µ—Ç—Ä–∏–∫–∏</button>
                    <input type="file" id="fileInput" accept=".json,.txt,.py,.js,.ts,.html,.css,.md,.xml,.yaml,.yml" style="display: none;">
                </div>
            `;
            
            const searchBarHtml = `
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫ –ø–æ –∫–∞–ø—Å—É–ª—ñ..." class="search-input">
                    <select id="layerFilter" class="layer-filter">
                        <option value="">–í—Å—ñ —à–∞—Ä–∏</option>
                        <option value="mova">MOVA</option>
                        <option value="jalm">JALM</option>
                        <option value="code">CODE</option>
                        <option value="log">LOG</option>
                        <option value="error">ERROR</option>
                    </select>
                </div>
            `;

            if (!currentData) {
                mainContent.innerHTML = `
                    ${toolbarHtml}
                    ${searchBarHtml}
                    <div class="empty-state">–û–±–µ—Ä—ñ—Ç—å —à–∞—Ä–∏ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –¥–∞–Ω—ñ</div>
                `;
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
                setTimeout(() => {
                    addEventListeners();
                }, 100);
                return;
            }

            if (activeLayers.length === 0) {
                mainContent.innerHTML = `
                    ${toolbarHtml}
                    ${searchBarHtml}
                    <div class="empty-state">–û–±–µ—Ä—ñ—Ç—å —à–∞—Ä–∏ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É</div>
                `;
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
                setTimeout(() => {
                    addEventListeners();
                }, 100);
                return;
            }

            let html = toolbarHtml + searchBarHtml;
            
            // –î–æ–¥–∞—î–º–æ –ø–∞–Ω–µ–ª—å –º–µ—Ç—Ä–∏–∫
            html += `
                <div class="metrics-panel" id="metricsPanel">
                    <div class="metrics-header">
                        <div class="metrics-title">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –∫–æ–¥—É</div>
                        <button class="metrics-toggle" onclick="toggleMetrics()">–°—Ö–æ–≤–∞—Ç–∏</button>
                    </div>
                    <div class="metrics-grid" id="metricsGrid">
                        <!-- –ú–µ—Ç—Ä–∏–∫–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                    </div>
                    <div class="layer-metrics" id="layerMetrics">
                        <!-- –ú–µ—Ç—Ä–∏–∫–∏ —à–∞—Ä—ñ–≤ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                    </div>
                </div>
            `;
            

            
            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —à–∞—Ä–∏
            let filteredLayers = activeLayers;
            if (layerFilter) {
                filteredLayers = activeLayers.filter(layer => layer === layerFilter);
            }

            filteredLayers.forEach(layer => {
                const data = currentData[layer];
                if (!data) return;
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç
                const searchText = data.short.toLowerCase() + ' ' + data.full.toLowerCase();
                if (searchQuery && !searchText.includes(searchQuery)) {
                    return;
                }
                
                const colorClass = `${layer}-text`;
                const iconClass = layer;
                const contentClass = `${layer}-content`;

                // –í–∏–∑–Ω–∞—á–∞—î–º–æ –º–æ–≤—É –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É
                let language = getLanguageForLayer(layer);

                html += `
                    <div class="layer-item">
                        <div class="layer-header" onclick="toggleExpand('${layer}')">
                            <div class="layer-icon ${iconClass}"></div>
                            <div class="layer-text ${colorClass}">${data.short}</div>
                            <button class="expand-btn" id="expand-${layer}">‚ñ∏</button>
                        </div>
                        <div class="layer-content ${colorClass} ${contentClass}" id="content-${layer}">
                            <div class="edit-controls">
                                <button class="edit-btn" onclick="toggleEdit('${layer}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                                <button class="save-btn" onclick="saveEdit('${layer}')" style="display: none;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                                <button class="cancel-btn" onclick="cancelEdit('${layer}')" style="display: none;">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                            </div>
                            <div class="view-mode" id="view-${layer}">
                                <pre><code class="language-${language}">${escapeHtml(data.full)}</code></pre>
                            </div>
                            <div class="edit-mode" id="edit-${layer}" style="display: none;">
                                <textarea class="edit-textarea" id="textarea-${layer}">${escapeHtml(data.full)}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            });

            try {
                mainContent.innerHTML = html;
                
                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è:', error);
                mainContent.innerHTML = `
                    ${toolbarHtml}
                    ${searchBarHtml}
                    <div class="empty-state">–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</div>
                `;
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        function toggleEdit(layer) {
            const viewMode = document.getElementById(`view-${layer}`);
            const editMode = document.getElementById(`edit-${layer}`);
            const editBtn = viewMode.parentElement.querySelector('.edit-btn');
            const saveBtn = viewMode.parentElement.querySelector('.save-btn');
            const cancelBtn = viewMode.parentElement.querySelector('.cancel-btn');
            
            if (viewMode.style.display !== 'none') {
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                
                // –§–æ–∫—É—Å—É—î–º–æ—Å—è –Ω–∞ textarea
                const textarea = document.getElementById(`textarea-${layer}`);
                textarea.focus();
            }
        }

        function saveEdit(layer) {
            const textarea = document.getElementById(`textarea-${layer}`);
            const newContent = textarea.value;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
            if (currentData && currentData[layer]) {
                currentData[layer].full = newContent;
                currentData[layer].short = newContent.substring(0, 50) + (newContent.length > 50 ? '...' : '');
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                updateDisplay();
                
                // –î–æ–¥–∞—î–º–æ –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó
                addToHistory(`–í—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ —à–∞—Ä ${layer.toUpperCase()}`);
            }
        }

        function cancelEdit(layer) {
            const viewMode = document.getElementById(`view-${layer}`);
            const editMode = document.getElementById(`edit-${layer}`);
            const editBtn = viewMode.parentElement.querySelector('.edit-btn');
            const saveBtn = viewMode.parentElement.querySelector('.save-btn');
            const cancelBtn = viewMode.parentElement.querySelector('.cancel-btn');
            
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –≤–º—ñ—Å—Ç
            const textarea = document.getElementById(`textarea-${layer}`);
            if (currentData && currentData[layer]) {
                textarea.value = currentData[layer].full;
            }
            
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –≤ —Ä–µ–∂–∏–º –ø–µ—Ä–µ–≥–ª—è–¥—É
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
        function addEventListeners() {
            // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
            const loadDemoBtn = document.getElementById('loadDemo');
            const loadFromFileBtn = document.getElementById('loadFromFile');
            const loadFromAPIBtn = document.getElementById('loadFromAPI');
            const exportJSONBtn = document.getElementById('exportJSON');
            const exportTXTBtn = document.getElementById('exportTXT');
            const exportPYBtn = document.getElementById('exportPY');
            const saveToServerBtn = document.getElementById('saveToServer');
            const clearDataBtn = document.getElementById('clearData');
            const showMetricsBtn = document.getElementById('showMetrics');
            const fileInput = document.getElementById('fileInput');
            const searchInput = document.getElementById('searchInput');
            const layerFilter = document.getElementById('layerFilter');

            if (loadDemoBtn) loadDemoBtn.addEventListener('click', loadDemoData);
            if (loadFromFileBtn) loadFromFileBtn.addEventListener('click', loadFromFile);
            if (loadFromAPIBtn) loadFromAPIBtn.addEventListener('click', loadFromAPI);
            if (exportJSONBtn) exportJSONBtn.addEventListener('click', exportToJSON);
            if (exportTXTBtn) exportTXTBtn.addEventListener('click', exportToTXT);
            if (exportPYBtn) exportPYBtn.addEventListener('click', exportToPython);
            if (saveToServerBtn) saveToServerBtn.addEventListener('click', saveToServer);
            if (clearDataBtn) clearDataBtn.addEventListener('click', clearData);
            if (showMetricsBtn) {
                console.log('–î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è showMetricsBtn');
                showMetricsBtn.addEventListener('click', toggleMetrics);
            } else {
                console.log('showMetricsBtn –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
            }
            if (fileInput) fileInput.addEventListener('change', handleFileUpload);
            if (searchInput) searchInput.addEventListener('input', performSearch);
            if (layerFilter) layerFilter.addEventListener('change', performFilter);
        }

        // Event listeners –¥–ª—è –∫–Ω–æ–ø–æ–∫ —à–∞—Ä—ñ–≤
        document.querySelectorAll('.layer-square').forEach(btn => {
            btn.addEventListener('click', () => toggleLayer(btn.dataset.layer));
        });

        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            addEventListeners();
        });

        // Initialize
        updateDisplay();
    </script>
</body>
</html>