<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISKALA/MOVA Layered String Viewer</title>
    <!-- Prism.js для підсвічування синтаксису -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #ffffff;
            color: #333333;
            height: 100vh;
            display: flex;
        }

        .layer-picker {
            width: 80px;
            background: #f5f5f5;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            border-right: 1px solid #e0e0e0;
        }

        .layer-square {
            width: 50px;
            height: 50px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .layer-square:hover {
            transform: scale(1.1);
        }

        .layer-square.active {
            transform: scale(1.2);
            box-shadow: 0 0 15px currentColor;
        }

        .mova { background: #26a65b; }
        .jalm { background: #f1b80a; }
        .code { background: #1e50a2; }
        .log { background: #3b246c; }
        .error { background: #e53935; }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .layer-item {
            margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }

        .layer-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .layer-header:hover {
            background: #f0f0f0;
        }

        .layer-icon {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .layer-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.3s;
        }

        .expand-btn.expanded {
            transform: rotate(90deg);
        }

        .layer-content {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            display: none;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .edit-controls {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
        }

        .edit-btn, .save-btn, .cancel-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .edit-btn {
            background: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background: #0056b3;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .save-btn:hover {
            background: #1e7e34;
        }

        .cancel-btn {
            background: #dc3545;
            color: white;
        }

        .cancel-btn:hover {
            background: #c82333;
        }

        .edit-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            background: #fff;
        }

        .edit-textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0,123,255,0.3);
        }

        /* Панель метрик */
        .metrics-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .metrics-panel.show {
            display: block;
        }

        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .metrics-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .metrics-toggle {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .layer-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .layer-metric {
            background: white;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            border-left: 4px solid;
        }

        .layer-metric.mova { border-left-color: #26a65b; }
        .layer-metric.jalm { border-left-color: #f1b80a; }
        .layer-metric.code { border-left-color: #1e50a2; }
        .layer-metric.log { border-left-color: #3b246c; }
        .layer-metric.error { border-left-color: #e53935; }

        .layer-metric-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .layer-metric-label {
            font-size: 11px;
            color: #666;
        }

        .layer-content.expanded {
            display: block;
        }

        .mova-text { color: #26a65b; }
        .jalm-text { color: #f1b80a; }
        .code-text { color: #1e50a2; }
        .log-text { color: #3b246c; }
        .error-text { color: #e53935; }

        .empty-state {
            text-align: center;
            color: #999;
            margin-top: 50px;
            font-size: 18px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .toolbar-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .toolbar-btn:hover {
            background: #0056b3;
        }

        .toolbar-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .layer-filter {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        /* Стилі для підсвічування синтаксису */
        .layer-content pre {
            margin: 0;
            background: #2d3748;
            border-radius: 4px;
        }

        .layer-content code {
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
        }

        /* Кастомні стилі для різних мов */
        .jalm-content pre {
            background: #1a202c;
        }

        .code-content pre {
            background: #1e3a8a;
        }

        .log-content pre {
            background: #1e1b4b;
        }

        .error-content pre {
            background: #7f1d1d;
        }
    </style>
</head>
<body>
    <div class="layer-picker">
        <button class="layer-square mova" data-layer="mova" title="MOVA">💚</button>
        <button class="layer-square jalm" data-layer="jalm" title="JALM">🟨</button>
        <button class="layer-square code" data-layer="code" title="CODE">🟦</button>
        <button class="layer-square log" data-layer="log" title="LOG">🟪</button>
        <button class="layer-square error" data-layer="error" title="ERROR">🟥</button>
    </div>

    <div class="main-content" id="mainContent">
        <div class="toolbar">
            <button id="loadDemo" class="toolbar-btn">Завантажити демо</button>
            <button id="loadFromFile" class="toolbar-btn">Завантажити з файлу</button>
            <button id="loadFromAPI" class="toolbar-btn">Завантажити з API</button>
            <button id="exportJSON" class="toolbar-btn">Експорт JSON</button>
            <button id="exportTXT" class="toolbar-btn">Експорт TXT</button>
                                <input type="file" id="fileInput" accept=".json,.txt,.py,.js,.ts,.html,.css,.md,.xml,.yaml,.yml" style="display: none;">
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Пошук по капсулі..." class="search-input">
            <select id="layerFilter" class="layer-filter">
                <option value="">Всі шари</option>
                <option value="mova">MOVA</option>
                <option value="jalm">JALM</option>
                <option value="code">CODE</option>
                <option value="log">LOG</option>
                <option value="error">ERROR</option>
            </select>
        </div>
        <div class="empty-state">Оберіть шари для перегляду або завантажте дані</div>
    </div>

    <script>
        // Demo data
        const capsule = {
            mova: {
                short: 'Додати задачу: Подати звіт до 15:00 завтра',
                full: `Додати задачу: Подати звіт до 15:00 завтра

Намір: створити нову задачу з описом і терміном виконання.
Контекст: щоденне планування, важливий звіт для команди.
Очікуваний результат: задача додана в систему з правильним терміном.`
            },
            jalm: {
                short: '{"намір":"створити_задачу","опис":"Подати звіт"}',
                full: JSON.stringify({
                    "намір": "створити_задачу",
                    "параметри": {
                        "опис": "Подати звіт",
                        "термін": "2024-07-26 15:00",
                        "пріоритет": "високий",
                        "теги": ["звіт", "команда", "терміново"]
                    },
                    "контекст": {
                        "користувач": "user123",
                        "час_створення": "2024-07-25T23:59:00Z"
                    }
                }, null, 2)
            },
            code: {
                short: 'create_task("Подати звіт", "2024-07-26 15:00")',
                full: `def create_task(description, due_date, priority="medium", tags=None):
    """
    Створити нову задачу в системі Todoist

    Args:
        description (str): Опис задачі
        due_date (str): Дата виконання у форматі YYYY-MM-DD HH:MM
        priority (str): Пріоритет задачі (low/medium/high)
        tags (list): Список тегів

    Returns:
        dict: Результат операції з ID нової задачі
    """
    import requests
    import json
    from datetime import datetime

    # Перетворення дати
    due_datetime = datetime.strptime(due_date, "%Y-%m-%d %H:%M")

    # Підготовка даних
    task_data = {
        "content": description,
        "due_datetime": due_datetime.isoformat(),
        "priority": priority_map[priority],
        "labels": tags or []
    }

    # Відправка запиту
    response = requests.post(
        "https://api.todoist.com/rest/v2/tasks",
        headers={"Authorization": f"Bearer {API_TOKEN}"},
        json=task_data
    )

    return response.json()`
            },
            log: {
                short: '[23:59] Запит виконано',
                full: `[23:59:15] Початок обробки наміру: створити_задачу
[23:59:16] Валідація параметрів: успішно
[23:59:17] Підключення до Todoist API
[23:59:18] Відправка POST /rest/v2/tasks
[23:59:19] Отримано відповідь: 200 OK
[23:59:20] Задача створена з ID: 123456789
[23:59:21] Збережено в локальній базі даних
[23:59:22] Обробка завершена успішно`
            },
            error: {
                short: '[ПОМИЛКА] Невірний формат дати',
                full: `Traceback (most recent call last):
  File "/app/mova_handler.py", line 45, in process_intent
    task_id = create_task(description, due_date)
  File "/app/todoist_api.py", line 23, in create_task
    due_datetime = datetime.strptime(due_date, "%Y-%m-%d %H:%M")
ValueError: time data 'завтра 15:00' does not match format '%Y-%m-%d %H:%M'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/app/main.py", line 78, in handle_request
    result = process_intent(intent_data)
  File "/app/mova_handler.py", line 52, in process_intent
    raise IntentProcessingError(f"Failed to create task: {str(e)}")
IntentProcessingError: Failed to create task: time data 'завтра 15:00' does not match format '%Y-%m-%d %H:%M'`
            }
        };

        let activeLayers = [];
        let currentData = null;
        let searchQuery = '';
        let layerFilter = '';
        let viewHistory = [];

        // Функція для завантаження демо даних
        function loadDemoData() {
            currentData = capsule;
            updateDisplay();
            addToHistory('Завантажено демо дані');
            
            // Скидаємо стан кнопок
            const loadDemoBtn = document.getElementById('loadDemo');
            const loadFromFileBtn = document.getElementById('loadFromFile');
            const loadFromAPIBtn = document.getElementById('loadFromAPI');
            
            if (loadDemoBtn) loadDemoBtn.disabled = false;
            if (loadFromFileBtn) loadFromFileBtn.disabled = false;
            if (loadFromAPIBtn) loadFromAPIBtn.disabled = false;
        }

        // Функція для завантаження з файлу
        function loadFromFile() {
            document.getElementById('fileInput').click();
        }

        // Функція для завантаження з API
        async function loadFromAPI() {
            try {
                const response = await fetch('/api/capsule/latest');
                if (response.ok) {
                    currentData = await response.json();
                    updateDisplay();
                    addToHistory('Завантажено з API');
                    
                    // Скидаємо стан кнопок
                    const loadFromFileBtn = document.getElementById('loadFromFile');
                    const loadFromAPIBtn = document.getElementById('loadFromAPI');
                    if (loadFromFileBtn) loadFromFileBtn.disabled = false;
                    if (loadFromAPIBtn) loadFromAPIBtn.disabled = false;
                } else {
                    alert('Помилка завантаження з API: ' + response.statusText);
                }
            } catch (error) {
                alert('Помилка підключення до API: ' + error.message);
            }
        }

        // Функція для аналізу Python файлу
        function analyzePythonFile(content) {
            const lines = content.split('\n');
            const result = {
                mova: { short: '', full: '' },
                jalm: { short: '', full: '' },
                code: { short: '', full: '' },
                log: { short: '', full: '' },
                error: { short: '', full: '' }
            };
            
            let codeLines = [];
            let logLines = [];
            let errorLines = [];
            let movaLines = [];
            let jalmLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // MOVA: Інтерфейс та користувацький досвід
                if (trimmedLine.includes('app.route') || 
                    trimmedLine.includes('send_from_directory') ||
                    trimmedLine.includes('jsonify') ||
                    trimmedLine.includes('request') ||
                    trimmedLine.includes('render_template') ||
                    trimmedLine.includes('redirect') ||
                    trimmedLine.includes('url_for') ||
                    trimmedLine.includes('flash') ||
                    trimmedLine.includes('session') ||
                    trimmedLine.includes('cookies') ||
                    trimmedLine.includes('headers') ||
                    trimmedLine.includes('user-agent') ||
                    trimmedLine.includes('content-type') ||
                    trimmedLine.includes('cors') ||
                    trimmedLine.includes('static') ||
                    trimmedLine.includes('templates')) {
                    movaLines.push(line);
                }
                // JALM: Бізнес-логіка та алгоритми
                else if (trimmedLine.includes('def ') && 
                        (trimmedLine.includes('validate') || 
                         trimmedLine.includes('process') || 
                         trimmedLine.includes('calculate') || 
                         trimmedLine.includes('transform') || 
                         trimmedLine.includes('parse') || 
                         trimmedLine.includes('format') || 
                         trimmedLine.includes('convert') || 
                         trimmedLine.includes('generate') || 
                         trimmedLine.includes('create') || 
                         trimmedLine.includes('update') || 
                         trimmedLine.includes('delete') || 
                         trimmedLine.includes('search') || 
                         trimmedLine.includes('filter') || 
                         trimmedLine.includes('sort'))) {
                    jalmLines.push(line);
                }
                // Логи
                else if (trimmedLine.includes('print(') || 
                         trimmedLine.includes('logging.') || 
                         trimmedLine.includes('logger.') ||
                         trimmedLine.includes('console.log') ||
                         trimmedLine.includes('debug') ||
                         trimmedLine.includes('info') ||
                         trimmedLine.includes('warning')) {
                    logLines.push(line);
                }
                // Обробка помилок
                else if (trimmedLine.includes('except') || 
                         trimmedLine.includes('raise') || 
                         trimmedLine.includes('error') || 
                         trimmedLine.includes('Error') ||
                         trimmedLine.includes('try:') ||
                         trimmedLine.includes('finally:') ||
                         trimmedLine.includes('return jsonify({"error":') ||
                         trimmedLine.includes('return jsonify({"success": false') ||
                         trimmedLine.includes('status_code') ||
                         trimmedLine.includes('HTTPException')) {
                    errorLines.push(line);
                }
                // Основний код
                else if (trimmedLine.length > 0) {
                    codeLines.push(line);
                }
            }
            
            // Формуємо результати з кращими описami
            result.mova.short = movaLines.length > 0 ? 
                `MOVA інтерфейс (${movaLines.length} рядків)` : 'Немає MOVA даних';
            result.mova.full = movaLines.join('\n') || 'Немає MOVA даних';
            
            result.jalm.short = jalmLines.length > 0 ? 
                `JALM логіка (${jalmLines.length} рядків)` : 'Немає JALM даних';
            result.jalm.full = jalmLines.join('\n') || 'Немає JALM даних';
            
            result.code.short = codeLines.length > 0 ? 
                `Python код (${codeLines.length} рядків)` : 'Немає коду';
            result.code.full = codeLines.join('\n') || 'Немає коду';
            
            result.log.short = logLines.length > 0 ? 
                `Логи (${logLines.length} рядків)` : 'Немає логів';
            result.log.full = logLines.join('\n') || 'Немає логів';
            
            result.error.short = errorLines.length > 0 ? 
                `Обробка помилок (${errorLines.length} рядків)` : 'Немає помилок';
            result.error.full = errorLines.join('\n') || 'Немає помилок';
            
            return result;
        }

        // Функція для аналізу файлів за мовою програмування
        function analyzeFileByLanguage(content, filename) {
            const extension = filename.split('.').pop().toLowerCase();
            
            switch (extension) {
                case 'py':
                    return analyzePythonFile(content);
                case 'js':
                case 'ts':
                    return analyzeJavaScriptFile(content);
                case 'json':
                    return analyzeJsonFile(content);
                case 'html':
                    return analyzeHtmlFile(content);
                case 'css':
                    return analyzeCssFile(content);
                case 'md':
                    return analyzeMarkdownFile(content);
                case 'xml':
                case 'yaml':
                case 'yml':
                    return analyzeConfigFile(content, extension);
                default:
                    return analyzeGenericFile(content);
            }
        }

        function analyzeJavaScriptFile(content) {
            const lines = content.split('\n');
            const movaLines = [];
            const jalmLines = [];
            const codeLines = [];
            const logLines = [];
            const errorLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // MOVA - DOM manipulation, event handlers, API calls
                if (trimmedLine.includes('document.') ||
                    trimmedLine.includes('addEventListener') ||
                    trimmedLine.includes('fetch(') ||
                    trimmedLine.includes('XMLHttpRequest') ||
                    trimmedLine.includes('querySelector') ||
                    trimmedLine.includes('getElementById') ||
                    trimmedLine.includes('innerHTML') ||
                    trimmedLine.includes('style.') ||
                    trimmedLine.includes('classList.') ||
                    trimmedLine.includes('appendChild') ||
                    trimmedLine.includes('removeChild') ||
                    trimmedLine.includes('createElement')) {
                    movaLines.push(line);
                }
                // JALM - business logic functions
                else if (trimmedLine.includes('function ') && (
                    trimmedLine.includes('validate') ||
                    trimmedLine.includes('process') ||
                    trimmedLine.includes('calculate') ||
                    trimmedLine.includes('transform') ||
                    trimmedLine.includes('parse') ||
                    trimmedLine.includes('format') ||
                    trimmedLine.includes('convert') ||
                    trimmedLine.includes('generate') ||
                    trimmedLine.includes('create') ||
                    trimmedLine.includes('update') ||
                    trimmedLine.includes('delete') ||
                    trimmedLine.includes('search') ||
                    trimmedLine.includes('filter') ||
                    trimmedLine.includes('sort'))) {
                    jalmLines.push(line);
                }
                // CODE - general code
                else if (trimmedLine.includes('function ') || 
                         trimmedLine.includes('const ') ||
                         trimmedLine.includes('let ') ||
                         trimmedLine.includes('var ') ||
                         trimmedLine.includes('if ') ||
                         trimmedLine.includes('for ') ||
                         trimmedLine.includes('while ') ||
                         trimmedLine.includes('try {') ||
                         trimmedLine.includes('catch') ||
                         trimmedLine.includes('return ') ||
                         trimmedLine.includes('=') ||
                         trimmedLine.includes('(') ||
                         trimmedLine.includes('[') ||
                         trimmedLine.includes('{')) {
                    codeLines.push(line);
                }
                // LOG - console statements
                else if (trimmedLine.includes('console.log') || 
                         trimmedLine.includes('console.info') ||
                         trimmedLine.includes('console.warn') ||
                         trimmedLine.includes('console.error') ||
                         trimmedLine.includes('alert(') ||
                         trimmedLine.includes('log(') ||
                         trimmedLine.includes('info(') ||
                         trimmedLine.includes('warn(') ||
                         trimmedLine.includes('error(')) {
                    logLines.push(line);
                }
                // ERROR - error handling
                else if (trimmedLine.includes('catch') || 
                         trimmedLine.includes('throw ') ||
                         trimmedLine.includes('Error') ||
                         trimmedLine.includes('Exception') ||
                         trimmedLine.includes('reject') ||
                         trimmedLine.includes('error')) {
                    errorLines.push(line);
                }
                // Comments and empty lines
                else if (trimmedLine.startsWith('//') || trimmedLine.startsWith('/*') || trimmedLine === '') {
                    // Skip comments and empty lines
                }
                // Everything else goes to CODE
                else {
                    codeLines.push(line);
                }
            }

            return {
                mova: {
                    short: `MOVA інтерфейс (${movaLines.length} рядків)`,
                    full: movaLines.join('\n')
                },
                jalm: {
                    short: `JALM логіка (${jalmLines.length} рядків)`,
                    full: jalmLines.join('\n')
                },
                code: {
                    short: `JavaScript код (${codeLines.length} рядків)`,
                    full: codeLines.join('\n')
                },
                log: {
                    short: `Логи (${logLines.length} рядків)`,
                    full: logLines.join('\n')
                },
                error: {
                    short: `Обробка помилок (${errorLines.length} рядків)`,
                    full: errorLines.join('\n')
                }
            };
        }

        function analyzeJsonFile(content) {
            try {
                const data = JSON.parse(content);
                const jsonStr = JSON.stringify(data, null, 2);
                const lines = jsonStr.split('\n');
                
                return {
                    mova: {
                        short: `JSON структура (${lines.length} рядків)`,
                        full: jsonStr
                    },
                    jalm: {
                        short: `Дані (${Object.keys(data).length} ключів)`,
                        full: JSON.stringify(data, null, 2)
                    },
                    code: {
                        short: `Схема JSON`,
                        full: generateJsonSchema(data)
                    },
                    log: {
                        short: `Валідація`,
                        full: validateJson(data)
                    },
                    error: {
                        short: `Помилки парсингу`,
                        full: ''
                    }
                };
            } catch (e) {
                return {
                    mova: {
                        short: `JSON файл`,
                        full: content
                    },
                    jalm: {
                        short: `Помилка парсингу`,
                        full: e.message
                    },
                    code: {
                        short: `Структура`,
                        full: content
                    },
                    log: {
                        short: `Логи`,
                        full: ''
                    },
                    error: {
                        short: `Помилка: ${e.message}`,
                        full: e.stack
                    }
                };
            }
        }

        function analyzeHtmlFile(content) {
            const lines = content.split('\n');
            const movaLines = [];
            const jalmLines = [];
            const codeLines = [];
            const logLines = [];
            const errorLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // MOVA - HTML structure, forms, links
                if (trimmedLine.includes('<html') ||
                    trimmedLine.includes('<head') ||
                    trimmedLine.includes('<body') ||
                    trimmedLine.includes('<form') ||
                    trimmedLine.includes('<input') ||
                    trimmedLine.includes('<button') ||
                    trimmedLine.includes('<a ') ||
                    trimmedLine.includes('<div') ||
                    trimmedLine.includes('<span') ||
                    trimmedLine.includes('<p>') ||
                    trimmedLine.includes('<h1') ||
                    trimmedLine.includes('<h2') ||
                    trimmedLine.includes('<h3')) {
                    movaLines.push(line);
                }
                // JALM - JavaScript in HTML
                else if (trimmedLine.includes('<script') ||
                         trimmedLine.includes('function ') ||
                         trimmedLine.includes('const ') ||
                         trimmedLine.includes('let ') ||
                         trimmedLine.includes('var ')) {
                    jalmLines.push(line);
                }
                // CODE - CSS, meta tags, other elements
                else if (trimmedLine.includes('<style') ||
                         trimmedLine.includes('<link') ||
                         trimmedLine.includes('<meta') ||
                         trimmedLine.includes('<title') ||
                         trimmedLine.includes('class=') ||
                         trimmedLine.includes('id=') ||
                         trimmedLine.includes('style=')) {
                    codeLines.push(line);
                }
                // LOG - comments
                else if (trimmedLine.includes('<!--') ||
                         trimmedLine.includes('-->')) {
                    logLines.push(line);
                }
                // ERROR - broken tags
                else if (trimmedLine.includes('<') && !trimmedLine.includes('>')) {
                    errorLines.push(line);
                }
                // Everything else
                else {
                    codeLines.push(line);
                }
            }

            return {
                mova: {
                    short: `HTML структура (${movaLines.length} рядків)`,
                    full: movaLines.join('\n')
                },
                jalm: {
                    short: `JavaScript (${jalmLines.length} рядків)`,
                    full: jalmLines.join('\n')
                },
                code: {
                    short: `CSS та мета-теги (${codeLines.length} рядків)`,
                    full: codeLines.join('\n')
                },
                log: {
                    short: `Коментарі (${logLines.length} рядків)`,
                    full: logLines.join('\n')
                },
                error: {
                    short: `Помилки HTML (${errorLines.length} рядків)`,
                    full: errorLines.join('\n')
                }
            };
        }

        function analyzeCssFile(content) {
            const lines = content.split('\n');
            const movaLines = [];
            const jalmLines = [];
            const codeLines = [];
            const logLines = [];
            const errorLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // MOVA - layout and positioning
                if (trimmedLine.includes('display:') ||
                    trimmedLine.includes('position:') ||
                    trimmedLine.includes('flex') ||
                    trimmedLine.includes('grid') ||
                    trimmedLine.includes('margin:') ||
                    trimmedLine.includes('padding:') ||
                    trimmedLine.includes('width:') ||
                    trimmedLine.includes('height:')) {
                    movaLines.push(line);
                }
                // JALM - animations and transitions
                else if (trimmedLine.includes('animation:') ||
                         trimmedLine.includes('transition:') ||
                         trimmedLine.includes('transform:') ||
                         trimmedLine.includes('@keyframes') ||
                         trimmedLine.includes('hover') ||
                         trimmedLine.includes('active')) {
                    jalmLines.push(line);
                }
                // CODE - general styles
                else if (trimmedLine.includes('{') ||
                         trimmedLine.includes('}') ||
                         trimmedLine.includes(':') ||
                         trimmedLine.includes(';')) {
                    codeLines.push(line);
                }
                // LOG - comments
                else if (trimmedLine.includes('/*') ||
                         trimmedLine.includes('*/')) {
                    logLines.push(line);
                }
                // ERROR - invalid CSS
                else if (trimmedLine.includes(';') && !trimmedLine.includes(':')) {
                    errorLines.push(line);
                }
                // Everything else
                else {
                    codeLines.push(line);
                }
            }

            return {
                mova: {
                    short: `CSS layout (${movaLines.length} рядків)`,
                    full: movaLines.join('\n')
                },
                jalm: {
                    short: `CSS анімації (${jalmLines.length} рядків)`,
                    full: jalmLines.join('\n')
                },
                code: {
                    short: `CSS стилі (${codeLines.length} рядків)`,
                    full: codeLines.join('\n')
                },
                log: {
                    short: `CSS коментарі (${logLines.length} рядків)`,
                    full: logLines.join('\n')
                },
                error: {
                    short: `CSS помилки (${errorLines.length} рядків)`,
                    full: errorLines.join('\n')
                }
            };
        }

        function analyzeMarkdownFile(content) {
            const lines = content.split('\n');
            const movaLines = [];
            const jalmLines = [];
            const codeLines = [];
            const logLines = [];
            const errorLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // MOVA - headers and structure
                if (trimmedLine.startsWith('#') ||
                    trimmedLine.startsWith('##') ||
                    trimmedLine.startsWith('###') ||
                    trimmedLine.includes('[') && trimmedLine.includes('](') ||
                    trimmedLine.includes('![')) {
                    movaLines.push(line);
                }
                // JALM - code blocks
                else if (trimmedLine.includes('```') ||
                         trimmedLine.includes('`') ||
                         trimmedLine.includes('    ')) {
                    jalmLines.push(line);
                }
                // CODE - lists and formatting
                else if (trimmedLine.startsWith('- ') ||
                         trimmedLine.startsWith('* ') ||
                         trimmedLine.startsWith('1. ') ||
                         trimmedLine.includes('**') ||
                         trimmedLine.includes('*') ||
                         trimmedLine.includes('>')) {
                    codeLines.push(line);
                }
                // LOG - comments
                else if (trimmedLine.includes('<!--') ||
                         trimmedLine.includes('-->')) {
                    logLines.push(line);
                }
                // ERROR - broken markdown
                else if (trimmedLine.includes('[') && !trimmedLine.includes(']')) {
                    errorLines.push(line);
                }
                // Everything else
                else {
                    codeLines.push(line);
                }
            }

            return {
                mova: {
                    short: `Markdown структура (${movaLines.length} рядків)`,
                    full: movaLines.join('\n')
                },
                jalm: {
                    short: `Код блоки (${jalmLines.length} рядків)`,
                    full: jalmLines.join('\n')
                },
                code: {
                    short: `Форматування (${codeLines.length} рядків)`,
                    full: codeLines.join('\n')
                },
                log: {
                    short: `Коментарі (${logLines.length} рядків)`,
                    full: logLines.join('\n')
                },
                error: {
                    short: `Помилки Markdown (${errorLines.length} рядків)`,
                    full: errorLines.join('\n')
                }
            };
        }

        function analyzeConfigFile(content, extension) {
            const lines = content.split('\n');
            
            return {
                mova: {
                    short: `${extension.toUpperCase()} конфігурація`,
                    full: content
                },
                jalm: {
                    short: `Параметри`,
                    full: content
                },
                code: {
                    short: `Структура`,
                    full: content
                },
                log: {
                    short: `Логи`,
                    full: ''
                },
                error: {
                    short: `Помилки`,
                    full: ''
                }
            };
        }

        function analyzeGenericFile(content) {
            const lines = content.split('\n');
            
            return {
                mova: {
                    short: `Файл (${lines.length} рядків)`,
                    full: content
                },
                jalm: {
                    short: `Дані`,
                    full: content
                },
                code: {
                    short: `Структура`,
                    full: content
                },
                log: {
                    short: `Логи`,
                    full: ''
                },
                error: {
                    short: `Помилки`,
                    full: ''
                }
            };
        }

        function generateJsonSchema(data) {
            // Проста генерація схеми JSON
            const schema = {};
            for (const key in data) {
                const value = data[key];
                schema[key] = typeof value;
            }
            return JSON.stringify(schema, null, 2);
        }

        function validateJson(data) {
            // Проста валідація JSON
            const errors = [];
            if (typeof data !== 'object') {
                errors.push('Кореневий елемент повинен бути об\'єктом');
            }
            return errors.length > 0 ? errors.join('\n') : 'JSON валідний';
        }

        // Функція для визначення мови підсвічування синтаксису
        function getLanguageForLayer(layer) {
            // Отримуємо поточний файл з глобальної змінної
            const currentFile = window.currentFileName || '';
            const extension = currentFile.split('.').pop().toLowerCase();
            
            // Базові налаштування для шарів
            const baseLanguages = {
                'jalm': 'json',
                'code': 'python',
                'log': 'log',
                'error': 'text',
                'mova': 'python'
            };
            
            // Спеціальні налаштування для різних типів файлів
            const fileTypeLanguages = {
                'js': {
                    'mova': 'javascript',
                    'jalm': 'javascript',
                    'code': 'javascript',
                    'log': 'javascript',
                    'error': 'javascript'
                },
                'ts': {
                    'mova': 'typescript',
                    'jalm': 'typescript',
                    'code': 'typescript',
                    'log': 'typescript',
                    'error': 'typescript'
                },
                'html': {
                    'mova': 'html',
                    'jalm': 'javascript',
                    'code': 'css',
                    'log': 'html',
                    'error': 'html'
                },
                'css': {
                    'mova': 'css',
                    'jalm': 'css',
                    'code': 'css',
                    'log': 'css',
                    'error': 'css'
                },
                'md': {
                    'mova': 'markdown',
                    'jalm': 'markdown',
                    'code': 'markdown',
                    'log': 'markdown',
                    'error': 'markdown'
                },
                'json': {
                    'mova': 'json',
                    'jalm': 'json',
                    'code': 'json',
                    'log': 'json',
                    'error': 'json'
                },
                'xml': {
                    'mova': 'xml',
                    'jalm': 'xml',
                    'code': 'xml',
                    'log': 'xml',
                    'error': 'xml'
                },
                'yaml': {
                    'mova': 'yaml',
                    'jalm': 'yaml',
                    'code': 'yaml',
                    'log': 'yaml',
                    'error': 'yaml'
                },
                'yml': {
                    'mova': 'yaml',
                    'jalm': 'yaml',
                    'code': 'yaml',
                    'log': 'yaml',
                    'error': 'yaml'
                }
            };
            
            // Перевіряємо чи є спеціальні налаштування для поточного типу файлу
            if (fileTypeLanguages[extension] && fileTypeLanguages[extension][layer]) {
                return fileTypeLanguages[extension][layer];
            }
            
            // Повертаємо базову мову для шару
            return baseLanguages[layer] || 'text';
        }

        // Обробка завантаження файлу
        function handleFileUpload(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let processedData;
                        
                        // Використовуємо нову функцію аналізу за мовою програмування
                        const extension = file.name.split('.').pop().toLowerCase();
                        
                        if (['js', 'ts', 'html', 'css', 'md', 'xml', 'yaml', 'yml'].includes(extension)) {
                            // Нові підтримувані формати
                            processedData = analyzeFileByLanguage(e.target.result, file.name);
                        } else if (file.name.endsWith('.py')) {
                            // Python файл
                            processedData = analyzePythonFile(e.target.result);
                        } else if (file.name.endsWith('.json')) {
                            // JSON файл
                            processedData = analyzeJsonFile(e.target.result);
                        } else {
                            // TXT або інші файли
                            try {
                                const parsedData = JSON.parse(e.target.result);
                                
                                // Перевіряємо структуру даних
                                if (!parsedData || typeof parsedData !== 'object') {
                                    throw new Error('Дані не є об\'єктом');
                                }
                                
                                // Якщо дані приходять як масив, конвертуємо в об'єкт
                                processedData = parsedData;
                                if (Array.isArray(parsedData)) {
                                    processedData = {
                                        mova: { short: 'MOVA дані', full: JSON.stringify(parsedData, null, 2) },
                                        jalm: { short: 'JALM дані', full: JSON.stringify(parsedData, null, 2) },
                                        code: { short: 'CODE дані', full: JSON.stringify(parsedData, null, 2) },
                                        log: { short: 'LOG дані', full: JSON.stringify(parsedData, null, 2) },
                                        error: { short: 'ERROR дані', full: JSON.stringify(parsedData, null, 2) }
                                    };
                                }
                            } catch (parseError) {
                                // Якщо не JSON, обробляємо як звичайний текст
                                processedData = analyzeGenericFile(e.target.result);
                            }
                        }
                        
                        // Перевіряємо наявність необхідних шарів
                        const requiredLayers = ['mova', 'jalm', 'code', 'log', 'error'];
                        const missingLayers = requiredLayers.filter(layer => !processedData[layer]);
                        
                        if (missingLayers.length > 0) {
                            // Створюємо структуру з пустими даними
                            missingLayers.forEach(layer => {
                                processedData[layer] = {
                                    short: `Немає даних ${layer.toUpperCase()}`,
                                    full: `Дані для шару ${layer} відсутні`
                                };
                            });
                        }
                        
                        currentData = processedData;
                        // Зберігаємо назву файлу для визначення мови підсвічування
                        window.currentFileName = file.name;
                        addToHistory('Завантажено з файлу: ' + file.name);
                        updateDisplay();
                        
                        // Оновлюємо метрики якщо панель відкрита
                        const metricsPanel = document.getElementById('metricsPanel');
                        if (metricsPanel && metricsPanel.classList.contains('show')) {
                            displayMetrics();
                        }
                        
                        // Скидаємо стан кнопок після успішного завантаження
                        const loadFromFileBtn = document.getElementById('loadFromFile');
                        const loadFromAPIBtn = document.getElementById('loadFromAPI');
                        const fileInput = document.getElementById('fileInput');
                        
                        if (loadFromFileBtn) loadFromFileBtn.disabled = false;
                        if (loadFromAPIBtn) loadFromAPIBtn.disabled = false;
                        if (fileInput) fileInput.value = ''; // Скидаємо file input
                    } catch (error) {
                        console.error('Помилка парсингу файлу:', error);
                        alert('Помилка парсингу файлу: ' + error.message);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('Помилка читання файлу:', error);
                    alert('Помилка читання файлу');
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error('Помилка обробки файлу:', error);
                alert('Помилка обробки файлу: ' + error.message);
            }
        }

        // Функція експорту в JSON
        function exportToJSON() {
            if (!currentData) {
                alert('Немає даних для експорту');
                return;
            }
            
            const dataStr = JSON.stringify(currentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `capsule_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Функція експорту в TXT
        function exportToTXT() {
            if (!currentData) {
                alert('Немає даних для експорту');
                return;
            }
            
            let txtContent = 'ISKALA/MOVA Capsule Export\n';
            txtContent += '='.repeat(50) + '\n\n';
            
            Object.keys(currentData).forEach(layer => {
                const data = currentData[layer];
                txtContent += `${layer.toUpperCase()}:\n`;
                txtContent += '-'.repeat(20) + '\n';
                txtContent += `Short: ${data.short}\n`;
                txtContent += `Full: ${data.full}\n\n`;
            });
            
            const dataBlob = new Blob([txtContent], {type: 'text/plain'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `capsule_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Функція обчислення метрик коду
        function calculateMetrics() {
            if (!currentData) return null;
            
            const metrics = {
                totalLines: 0,
                totalFunctions: 0,
                totalClasses: 0,
                totalImports: 0,
                complexity: 0,
                layers: {}
            };
            
            // Аналізуємо кожен шар
            Object.keys(currentData).forEach(layer => {
                const data = currentData[layer];
                if (!data || !data.full) return;
                
                const lines = data.full.split('\n').filter(line => line.trim().length > 0);
                const layerMetrics = {
                    lines: lines.length,
                    characters: data.full.length,
                    functions: (data.full.match(/def\s+\w+/g) || []).length,
                    classes: (data.full.match(/class\s+\w+/g) || []).length,
                    imports: (data.full.match(/import\s+|from\s+/g) || []).length,
                    complexity: calculateComplexity(data.full)
                };
                
                metrics.layers[layer] = layerMetrics;
                metrics.totalLines += layerMetrics.lines;
                metrics.totalFunctions += layerMetrics.functions;
                metrics.totalClasses += layerMetrics.classes;
                metrics.totalImports += layerMetrics.imports;
                metrics.complexity += layerMetrics.complexity;
            });
            
            return metrics;
        }

        // Функція обчислення складності коду
        function calculateComplexity(code) {
            let complexity = 0;
            
            // Додаємо складність за різні патерни
            complexity += (code.match(/if\s+/g) || []).length;
            complexity += (code.match(/for\s+/g) || []).length;
            complexity += (code.match(/while\s+/g) || []).length;
            complexity += (code.match(/try\s*:/g) || []).length;
            complexity += (code.match(/except\s+/g) || []).length;
            complexity += (code.match(/def\s+/g) || []).length * 2; // Функції додають складність
            complexity += (code.match(/class\s+/g) || []).length * 3; // Класи додають більше складності
            
            return complexity;
        }

        // Функція відображення метрик
        function displayMetrics() {
            const metrics = calculateMetrics();
            if (!metrics) return;
            
            const metricsGrid = document.getElementById('metricsGrid');
            const layerMetrics = document.getElementById('layerMetrics');
            
            // Загальні метрики
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalLines}</div>
                    <div class="metric-label">Всього рядків</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalFunctions}</div>
                    <div class="metric-label">Функцій</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalClasses}</div>
                    <div class="metric-label">Класів</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalImports}</div>
                    <div class="metric-label">Імпортів</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.complexity}</div>
                    <div class="metric-label">Складність</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${Object.keys(metrics.layers).length}</div>
                    <div class="metric-label">Активних шарів</div>
                </div>
            `;
            
            // Метрики по шарах
            layerMetrics.innerHTML = '';
            Object.keys(metrics.layers).forEach(layer => {
                const layerData = metrics.layers[layer];
                const layerName = layer.toUpperCase();
                
                layerMetrics.innerHTML += `
                    <div class="layer-metric ${layer}">
                        <div class="layer-metric-value">${layerData.lines}</div>
                        <div class="layer-metric-label">${layerName} (рядків)</div>
                    </div>
                `;
            });
        }

        // Функція перемикання панелі метрик
        function toggleMetrics() {
            console.log('toggleMetrics викликано');
            alert('Кнопка метрик натиснута!'); // Тестовий alert
            
            const panel = document.getElementById('metricsPanel');
            const button = document.querySelector('.metrics-toggle');
            
            console.log('panel:', panel);
            console.log('button:', button);
            
            if (panel && panel.classList.contains('show')) {
                panel.classList.remove('show');
                if (button) button.textContent = 'Показати';
            } else if (panel) {
                panel.classList.add('show');
                if (button) button.textContent = 'Сховати';
                displayMetrics();
            }
        }

        // Функція очищення даних
        function clearData() {
            if (confirm('Ви впевнені, що хочете очистити всі дані?')) {
                currentData = null;
                updateDisplay();
                addToHistory('Дані очищено');
                
                // Скидаємо file input
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
            }
        }

        // Функція збереження на сервер
        async function saveToServer() {
            if (!currentData) {
                alert('Немає даних для збереження');
                return;
            }
            
            try {
                const response = await fetch('/api/capsule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Капсула збережена успішно: ${result.filename}`);
                    addToHistory('Збережено на сервер');
                } else {
                    const error = await response.json();
                    alert(`Помилка збереження: ${error.error}`);
                }
            } catch (error) {
                alert(`Помилка підключення до сервера: ${error.message}`);
            }
        }

        // Функція експорту в Python
        function exportToPython() {
            if (!currentData) {
                alert('Немає даних для експорту');
                return;
            }
            
            let pyContent = '#!/usr/bin/env python3\n';
            pyContent += '# -*- coding: utf-8 -*-\n';
            pyContent += '"""\n';
            pyContent += 'ISKALA/MOVA Capsule Export\n';
            pyContent += 'Автоматично згенеровано з ISKALA/MOVA Viewer\n';
            pyContent += '"""\n\n';
            
            // Додаємо MOVA коментарі
            if (currentData.mova && currentData.mova.full && currentData.mova.full !== 'Немає MOVA даних') {
                pyContent += '# MOVA секція\n';
                pyContent += currentData.mova.full + '\n\n';
            }
            
            // Додаємо JALM коментарі
            if (currentData.jalm && currentData.jalm.full && currentData.jalm.full !== 'Немає JALM даних') {
                pyContent += '# JALM секція\n';
                pyContent += currentData.jalm.full + '\n\n';
            }
            
            // Додаємо основний код
            if (currentData.code && currentData.code.full && currentData.code.full !== 'Немає коду') {
                pyContent += '# CODE секція\n';
                pyContent += currentData.code.full + '\n\n';
            }
            
            // Додаємо логи
            if (currentData.log && currentData.log.full && currentData.log.full !== 'Немає логів') {
                pyContent += '# LOG секція\n';
                pyContent += currentData.log.full + '\n\n';
            }
            
            // Додаємо обробку помилок
            if (currentData.error && currentData.error.full && currentData.error.full !== 'Немає помилок') {
                pyContent += '# ERROR секція\n';
                pyContent += currentData.error.full + '\n\n';
            }
            
            const dataBlob = new Blob([pyContent], {type: 'text/plain'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `capsule_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.py`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Функція пошуку
        function performSearch() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase();
            updateDisplay();
        }

        // Функція фільтрації по шарах
        function performFilter() {
            layerFilter = document.getElementById('layerFilter').value;
            updateDisplay();
        }

        // Функція додавання до історії
        function addToHistory(action) {
            viewHistory.push({
                action: action,
                timestamp: new Date().toISOString(),
                layers: [...activeLayers]
            });
            
            // Зберігаємо тільки останні 10 дій
            if (viewHistory.length > 10) {
                viewHistory.shift();
            }
        }

        function toggleLayer(layer) {
            const index = activeLayers.indexOf(layer);
            if (index > -1) {
                activeLayers.splice(index, 1);
            } else {
                activeLayers.push(layer);
            }
            updateDisplay();
            updateLayerButtons();
        }

        function updateLayerButtons() {
            document.querySelectorAll('.layer-square').forEach(btn => {
                const layer = btn.dataset.layer;
                btn.classList.toggle('active', activeLayers.includes(layer));
            });
        }

        function toggleExpand(layer) {
            const content = document.getElementById(`content-${layer}`);
            const btn = document.getElementById(`expand-${layer}`);

            content.classList.toggle('expanded');
            btn.classList.toggle('expanded');
            btn.textContent = content.classList.contains('expanded') ? '▾' : '▸';
        }

        function updateDisplay() {
            
            const mainContent = document.getElementById('mainContent');
            
            // Створюємо toolbar та searchBar якщо їх немає
            const toolbarHtml = `
                <div class="toolbar">
                    <button id="loadDemo" class="toolbar-btn">Завантажити демо</button>
                    <button id="loadFromFile" class="toolbar-btn">Завантажити з файлу</button>
                    <button id="loadFromAPI" class="toolbar-btn">Завантажити з API</button>
                    <button id="exportJSON" class="toolbar-btn">Експорт JSON</button>
                    <button id="exportTXT" class="toolbar-btn">Експорт TXT</button>
                    <button id="exportPY" class="toolbar-btn">Експорт Python</button>
                    <button id="saveToServer" class="toolbar-btn">💾 Зберегти на сервер</button>
                    <button id="clearData" class="toolbar-btn">🗑️ Очистити</button>
                    <button id="showMetrics" class="toolbar-btn" onclick="toggleMetrics()">📊 Метрики</button>
                    <input type="file" id="fileInput" accept=".json,.txt,.py,.js,.ts,.html,.css,.md,.xml,.yaml,.yml" style="display: none;">
                </div>
            `;
            
            const searchBarHtml = `
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Пошук по капсулі..." class="search-input">
                    <select id="layerFilter" class="layer-filter">
                        <option value="">Всі шари</option>
                        <option value="mova">MOVA</option>
                        <option value="jalm">JALM</option>
                        <option value="code">CODE</option>
                        <option value="log">LOG</option>
                        <option value="error">ERROR</option>
                    </select>
                </div>
            `;

            if (!currentData) {
                mainContent.innerHTML = `
                    ${toolbarHtml}
                    ${searchBarHtml}
                    <div class="empty-state">Оберіть шари для перегляду або завантажте дані</div>
                `;
                // Додаємо обробники після створення елементів
                setTimeout(() => {
                    addEventListeners();
                }, 100);
                return;
            }

            if (activeLayers.length === 0) {
                mainContent.innerHTML = `
                    ${toolbarHtml}
                    ${searchBarHtml}
                    <div class="empty-state">Оберіть шари для перегляду</div>
                `;
                // Додаємо обробники після створення елементів
                setTimeout(() => {
                    addEventListeners();
                }, 100);
                return;
            }

            let html = toolbarHtml + searchBarHtml;
            
            // Додаємо панель метрик
            html += `
                <div class="metrics-panel" id="metricsPanel">
                    <div class="metrics-header">
                        <div class="metrics-title">📊 Аналітика коду</div>
                        <button class="metrics-toggle" onclick="toggleMetrics()">Сховати</button>
                    </div>
                    <div class="metrics-grid" id="metricsGrid">
                        <!-- Метрики будуть додано динамічно -->
                    </div>
                    <div class="layer-metrics" id="layerMetrics">
                        <!-- Метрики шарів будуть додано динамічно -->
                    </div>
                </div>
            `;
            

            
            // Фільтруємо шари
            let filteredLayers = activeLayers;
            if (layerFilter) {
                filteredLayers = activeLayers.filter(layer => layer === layerFilter);
            }

            filteredLayers.forEach(layer => {
                const data = currentData[layer];
                if (!data) return;
                
                // Перевіряємо пошуковий запит
                const searchText = data.short.toLowerCase() + ' ' + data.full.toLowerCase();
                if (searchQuery && !searchText.includes(searchQuery)) {
                    return;
                }
                
                const colorClass = `${layer}-text`;
                const iconClass = layer;
                const contentClass = `${layer}-content`;

                // Визначаємо мову для підсвічування синтаксису
                let language = getLanguageForLayer(layer);

                html += `
                    <div class="layer-item">
                        <div class="layer-header" onclick="toggleExpand('${layer}')">
                            <div class="layer-icon ${iconClass}"></div>
                            <div class="layer-text ${colorClass}">${data.short}</div>
                            <button class="expand-btn" id="expand-${layer}">▸</button>
                        </div>
                        <div class="layer-content ${colorClass} ${contentClass}" id="content-${layer}">
                            <div class="edit-controls">
                                <button class="edit-btn" onclick="toggleEdit('${layer}')">✏️ Редагувати</button>
                                <button class="save-btn" onclick="saveEdit('${layer}')" style="display: none;">💾 Зберегти</button>
                                <button class="cancel-btn" onclick="cancelEdit('${layer}')" style="display: none;">❌ Скасувати</button>
                            </div>
                            <div class="view-mode" id="view-${layer}">
                                <pre><code class="language-${language}">${escapeHtml(data.full)}</code></pre>
                            </div>
                            <div class="edit-mode" id="edit-${layer}" style="display: none;">
                                <textarea class="edit-textarea" id="textarea-${layer}">${escapeHtml(data.full)}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            });

            try {
                mainContent.innerHTML = html;
                
                // Застосовуємо підсвічування синтаксису
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            } catch (error) {
                console.error('Помилка оновлення відображення:', error);
                mainContent.innerHTML = `
                    ${toolbarHtml}
                    ${searchBarHtml}
                    <div class="empty-state">Помилка відображення даних</div>
                `;
            }
        }

        // Функція для екранування HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Функції для редагування
        function toggleEdit(layer) {
            const viewMode = document.getElementById(`view-${layer}`);
            const editMode = document.getElementById(`edit-${layer}`);
            const editBtn = viewMode.parentElement.querySelector('.edit-btn');
            const saveBtn = viewMode.parentElement.querySelector('.save-btn');
            const cancelBtn = viewMode.parentElement.querySelector('.cancel-btn');
            
            if (viewMode.style.display !== 'none') {
                // Переходимо в режим редагування
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                
                // Фокусуємося на textarea
                const textarea = document.getElementById(`textarea-${layer}`);
                textarea.focus();
            }
        }

        function saveEdit(layer) {
            const textarea = document.getElementById(`textarea-${layer}`);
            const newContent = textarea.value;
            
            // Оновлюємо дані
            if (currentData && currentData[layer]) {
                currentData[layer].full = newContent;
                currentData[layer].short = newContent.substring(0, 50) + (newContent.length > 50 ? '...' : '');
                
                // Оновлюємо відображення
                updateDisplay();
                
                // Додаємо до історії
                addToHistory(`Відредаговано шар ${layer.toUpperCase()}`);
            }
        }

        function cancelEdit(layer) {
            const viewMode = document.getElementById(`view-${layer}`);
            const editMode = document.getElementById(`edit-${layer}`);
            const editBtn = viewMode.parentElement.querySelector('.edit-btn');
            const saveBtn = viewMode.parentElement.querySelector('.save-btn');
            const cancelBtn = viewMode.parentElement.querySelector('.cancel-btn');
            
            // Повертаємо оригінальний вміст
            const textarea = document.getElementById(`textarea-${layer}`);
            if (currentData && currentData[layer]) {
                textarea.value = currentData[layer].full;
            }
            
            // Повертаємося в режим перегляду
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        // Функція для додавання обробників подій
        function addEventListeners() {
            // Обробники для кнопок
            const loadDemoBtn = document.getElementById('loadDemo');
            const loadFromFileBtn = document.getElementById('loadFromFile');
            const loadFromAPIBtn = document.getElementById('loadFromAPI');
            const exportJSONBtn = document.getElementById('exportJSON');
            const exportTXTBtn = document.getElementById('exportTXT');
            const exportPYBtn = document.getElementById('exportPY');
            const saveToServerBtn = document.getElementById('saveToServer');
            const clearDataBtn = document.getElementById('clearData');
            const showMetricsBtn = document.getElementById('showMetrics');
            const fileInput = document.getElementById('fileInput');
            const searchInput = document.getElementById('searchInput');
            const layerFilter = document.getElementById('layerFilter');

            if (loadDemoBtn) loadDemoBtn.addEventListener('click', loadDemoData);
            if (loadFromFileBtn) loadFromFileBtn.addEventListener('click', loadFromFile);
            if (loadFromAPIBtn) loadFromAPIBtn.addEventListener('click', loadFromAPI);
            if (exportJSONBtn) exportJSONBtn.addEventListener('click', exportToJSON);
            if (exportTXTBtn) exportTXTBtn.addEventListener('click', exportToTXT);
            if (exportPYBtn) exportPYBtn.addEventListener('click', exportToPython);
            if (saveToServerBtn) saveToServerBtn.addEventListener('click', saveToServer);
            if (clearDataBtn) clearDataBtn.addEventListener('click', clearData);
            if (showMetricsBtn) {
                console.log('Додаємо обробник для showMetricsBtn');
                showMetricsBtn.addEventListener('click', toggleMetrics);
            } else {
                console.log('showMetricsBtn не знайдено');
            }
            if (fileInput) fileInput.addEventListener('change', handleFileUpload);
            if (searchInput) searchInput.addEventListener('input', performSearch);
            if (layerFilter) layerFilter.addEventListener('change', performFilter);
        }

        // Event listeners для кнопок шарів
        document.querySelectorAll('.layer-square').forEach(btn => {
            btn.addEventListener('click', () => toggleLayer(btn.dataset.layer));
        });

        // Додаємо обробники при завантаженні сторінки
        document.addEventListener('DOMContentLoaded', function() {
            addEventListeners();
        });

        // Initialize
        updateDisplay();
    </script>
</body>
</html>